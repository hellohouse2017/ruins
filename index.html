<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruins Bar é«˜é›„å»¢å¢Ÿå ´åœ°ç§Ÿå€Ÿ | é ç´„ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Oswald:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ruin-dark': '#121212',
                        'ruin-gray': '#1e1e1e',
                        'neon-pink': '#ff0055',
                        'neon-blue': '#00f3ff',
                        'champagne': '#d4af37',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        display: ['"Oswald"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        input[type="date"] { position: relative; font-size: 1.1rem; }
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        /* åŠ è³¼æŒ‰éˆ•æ¨£å¼ */
        .addon-btn.selected { border-color: #00f3ff; background-color: rgba(0, 243, 255, 0.1); color: white; }
        .addon-btn.selected .check-icon { opacity: 1; background-color: #00f3ff; color: black; }
        .addon-btn.included { border-color: #06c755; background-color: rgba(6, 199, 85, 0.1); color: #88ffaa; cursor: default; }
        
        /* å¡ç‰‡ç‰¹æ•ˆ */
        .plan-card { transition: all 0.3s ease; }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
        .plan-card:hover img { transform: scale(1.05); }
        .plan-card img { transition: transform 0.8s ease; }
        .wedding-card:hover { border-color: #d4af37; box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); }

        .sticky-btn { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background-color: #06c755; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 40; transition: all 0.3s ease; text-decoration: none; cursor: pointer; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(6, 199, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0); } }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .counter-btn { width: 30px; height: 30px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .counter-btn:hover { background: #555; }

        .slot-btn { background-color: #1a1a1a; border: 1px solid #444; color: #888; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .slot-btn:hover { border-color: #666; color: white; }
        .slot-btn.active { background-color: rgba(0, 243, 255, 0.15); border-color: #00f3ff; color: #00f3ff; font-weight: bold; box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        .slot-btn span { font-size: 0.75rem; font-weight: normal; opacity: 0.8; }
        
        /* Loading Overlay */
        #loadingOverlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); transition: opacity 0.5s; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="font-sans antialiased selection:bg-neon-pink selection:text-white pb-24">

    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-neon-pink mb-4"></div>
        <p class="text-white text-lg font-bold">æ­£åœ¨è®€å–æœ€æ–°æ–¹æ¡ˆ...</p>
        <p class="text-gray-400 text-sm mt-2">Connecting to Google Database</p>
    </div>

    <nav class="fixed w-full z-50 bg-ruin-dark/95 backdrop-blur-md border-b border-white/10 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="font-display text-2xl font-bold tracking-wider text-white">RUINS <span class="text-neon-pink">BAR</span></span>
                </div>
                <div class="hidden lg:block">
                    <div class="ml-10 flex items-baseline space-x-6">
                        <a href="#plans-section" class="text-neon-blue hover:text-white transition px-3 py-2 rounded-md text-sm font-bold border border-neon-blue cursor-pointer"><i class="fas fa-calendar-check mr-1"></i> æ–¹æ¡ˆé ç´„</a>
                        <a href="#gallery" class="hover:text-neon-pink transition px-3 py-2 rounded-md text-sm font-medium">å¯¦éŒ„</a>
                        <a href="#reviews" class="hover:text-neon-pink transition px-3 py-2 rounded-md text-sm font-medium">å¥½è©•</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative bg-ruin-gray h-screen flex items-center justify-center overflow-hidden">
        <div class="absolute inset-0 z-0 opacity-40 bg-cover bg-center grayscale" style="background-image: url('images/cover-bg.jpg');"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-ruin-dark via-transparent to-ruin-dark z-10"></div>
        <div class="relative z-20 text-center px-4">
            <h1 class="font-display text-5xl md:text-7xl font-bold text-white mb-4 tracking-widest neon-text-pink">INDUSTRIAL RUINS</h1>
            <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-2xl mx-auto font-light">é«˜é›„é¹½åŸ• Ã— å»¢å¢Ÿç¾å­¸ Ã— æ¥µè‡´æ´¾å°é«”é©—</p>
            <a href="#plans-section" class="inline-block bg-neon-pink text-white font-bold py-4 px-10 rounded-full hover:bg-pink-600 transition duration-300 shadow-[0_0_20px_rgba(255,0,85,0.5)] cursor-pointer">
                é–‹å§‹é ç´„æ—…ç¨‹
            </a>
        </div>
    </div>

    <section id="plans-section" class="py-20 px-4 bg-ruin-dark relative z-30">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-white mb-10 text-center flex items-center justify-center"><i class="fas fa-list-ul text-neon-blue mr-3"></i> é¸æ“‡æ‚¨çš„æ´»å‹•æ–¹æ¡ˆ</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
                <div onclick="handleCardClick('proposal')" class="plan-card cursor-pointer group relative rounded-2xl overflow-hidden border-2 border-neon-pink/50 shadow-[0_0_30px_rgba(255,0,85,0.15)] hover:border-neon-pink bg-zinc-900 flex flex-col">
                    <div class="h-80 md:h-96 overflow-hidden relative w-full">
                        <img src="images/proposal-cover.jpg" onerror="this.src='https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?auto=format&fit=crop&q=80&w=1000'" class="w-full h-full object-cover">
                        <div class="absolute bottom-6 left-8 z-10">
                            <div class="text-white font-bold text-2xl mb-1 flex items-center"><i class="fas fa-heart text-neon-pink mr-3"></i> æµªæ¼«æ±‚å©šåŒ…å ´</div>
                        </div>
                    </div>
                    <div class="p-8 flex-grow flex flex-col justify-between">
                        <p class="text-gray-300 mb-4 text-base leading-relaxed">åŒ…å«æ°£çƒä½ˆç½®ã€MerryMeç‡ˆæ¢èˆ‡æ±‚å©šèŠ±æŸã€‚<br>è®“å»¢å¢Ÿçš„å…‰å½±æˆç‚ºä½ å€‘æ„›æƒ…çš„æœ€ä½³è¦‹è­‰ã€‚</p>
                        <div class="text-right text-neon-pink font-bold group-hover:translate-x-2 transition mt-4">æŸ¥çœ‹æ–¹æ¡ˆ <i class="fas fa-arrow-right ml-1"></i></div>
                    </div>
                </div>

                <div onclick="showSubPlanModal(['wedding_A', 'wedding_B'])" class="plan-card wedding-card cursor-pointer group relative rounded-2xl overflow-hidden border-2 border-champagne/50 shadow-[0_0_30px_rgba(212,175,55,0.15)] bg-zinc-900 flex flex-col">
                    <div class="h-80 md:h-96 overflow-hidden relative w-full">
                        <img src="images/wedding-cover.jpg" onerror="this.src='https://images.unsplash.com/photo-1511795409834-ef04bbd61622?auto=format&fit=crop&q=80&w=1000'" class="w-full h-full object-cover">
                        <div class="absolute bottom-6 left-8 z-10">
                            <div class="text-white font-bold text-2xl mb-1 flex items-center"><i class="fas fa-ring text-champagne mr-3"></i> å©šç¦®æ´¾å° & è­‰å©š</div>
                        </div>
                    </div>
                    <div class="p-8 flex-grow flex flex-col justify-between">
                        <p class="text-gray-300 mb-4 text-base leading-relaxed">æä¾› After Party èˆ‡ è­‰å©šå„€å¼+æ´¾å° é›™é‡é¸æ“‡ã€‚<br>åŒ…å«ç²¾ç·»è‡ªåŠ©é»å¿ƒã€é…’æ°´æš¢é£²èˆ‡DJæ¼”å‡ºã€‚</p>
                        <div class="text-right text-champagne font-bold group-hover:translate-x-2 transition mt-4">æŸ¥çœ‹è©³ç´° <i class="fas fa-arrow-right ml-1"></i></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div onclick="handleCardClick('baby')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1">æŠ“å‘¨ / æ€§åˆ¥æ´¾å°</h4>
                    <p class="text-gray-500 text-xs">å«æ°£çƒä½ˆç½®ã€é“å…·ã€é»å¿ƒ</p>
                </div>
                <div onclick="handleCardClick('party')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1">æ…¶ç”Ÿ / å„å¼æ´¾å°</h4>
                    <p class="text-gray-500 text-xs">å«é…’æ°´ã€ç²¾ç·»é»å¿ƒ</p>
                </div>
                <div onclick="handleCardClick('rental')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1">ç´”å ´åœ°ç§Ÿå€Ÿ</h4>
                    <p class="text-gray-500 text-xs">æœ€è‡ªç”±çš„ç©ºé–“ä½¿ç”¨</p>
                </div>
                <div onclick="handleCardClick('meeting')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1">æœƒè­°åŒ…å ´æ–¹æ¡ˆ</h4>
                    <p class="text-gray-500 text-xs">å«æ¡Œæ¤…ã€é£²å“</p>
                </div>
            </div>
        </div>
    </section>

    <div id="subPlanModal" class="hidden fixed inset-0 z-[70] overflow-y-auto" role="dialog">
        <div class="fixed inset-0 bg-black/90 transition-opacity backdrop-blur-sm" onclick="closeSubModal()"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-zinc-900 text-left shadow-2xl w-full max-w-lg border border-zinc-700">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-white mb-4 text-center">è«‹é¸æ“‡è©³ç´°æ–¹æ¡ˆ</h3>
                    <div id="subPlanContainer" class="space-y-4"></div>
                    <button onclick="closeSubModal()" class="mt-6 w-full text-gray-500 text-sm">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bookingModal" class="hidden fixed inset-0 z-[60] overflow-y-auto">
        <div class="fixed inset-0 bg-black/80 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-zinc-900 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-zinc-700">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10 p-2"><i class="fas fa-times text-2xl"></i></button>

                <div class="max-h-[85vh] overflow-y-auto p-6 scrollbar-hide">
                    <h3 class="text-center text-white font-bold mb-2 text-2xl flex justify-center items-center"><i class="fas fa-calendar-alt text-neon-blue mr-3"></i> é ç´„è©¦ç®—</h3>
                    <div class="bg-zinc-800 p-3 rounded-lg mb-6 text-center border border-zinc-700">
                        <span class="text-gray-400 text-xs block">æ‚¨ç›®å‰é¸æ“‡çš„æ–¹æ¡ˆ</span>
                        <span id="selectedPlanDisplay" class="text-neon-pink font-bold text-lg"></span>
                    </div>

                    <div id="step1">
                        <form id="checkForm" onsubmit="handleCheck(event)" class="space-y-4">
                            <div>
                                <label class="block text-neon-blue text-sm font-bold mb-1">1. é¸æ“‡é è¨ˆæ—¥æœŸ</label>
                                <div class="relative"><input type="date" id="dateInput" onchange="checkLogic()" onclick="this.showPicker()" required class="w-full bg-black border border-zinc-700 text-white rounded-lg p-3 focus:border-neon-blue focus:outline-none cursor-pointer"></div>
                                <p id="dayTypeLabel" class="text-xs text-gray-500 mt-1 text-right"></p>
                            </div>
                            <div>
                                <label class="block text-neon-blue text-sm font-bold mb-1">2. é¸æ“‡æ™‚æ®µ</label>
                                <div class="grid grid-cols-3 gap-2 mb-4" id="standardSlots">
                                    <button type="button" onclick="selectSlot('lunch')" id="btnLunch" class="slot-btn py-2 rounded-lg text-sm font-bold">åˆå ´<br><span class="text-xs font-normal">11:00-14:00</span></button>
                                    <button type="button" onclick="selectSlot('dinner')" id="btnDinner" class="slot-btn py-2 rounded-lg text-sm font-bold">æ™šå ´<br><span class="text-xs font-normal">17:00-20:00</span></button>
                                    <button type="button" onclick="selectSlot('allday')" id="btnAllDay" class="slot-btn py-2 rounded-lg text-sm font-bold hidden">å…¨æ—¥<br><span class="text-xs font-normal">09:00-21:00</span></button>
                                </div>
                                <div class="relative border-t border-zinc-700 pt-4 mt-2">
                                    <p class="text-xs text-gray-400 mb-2">æˆ– è‡ªè¨‚é–‹å§‹æ™‚é–“ (çµæŸè‡ªå‹•è¨ˆç®—)</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-white text-xs">é–‹å§‹</label><select id="startTime" onchange="customTimeTrigger()" class="w-full bg-black border-zinc-600 text-white rounded p-1"></select></div>
                                        <div><label class="text-white text-xs">çµæŸ</label><input type="text" id="endTimeDisplay" readonly class="w-full bg-[#1a1a1a] border border-zinc-600 text-gray-400 rounded p-1 text-center" value="è‡ªå‹•è¨ˆç®—"><input type="hidden" id="endTime"></div>
                                    </div>
                                </div>
                            </div>
                            <button id="submitBtn" type="submit" class="w-full bg-neon-blue text-black font-bold py-3 rounded-lg hover:bg-[#00d0dd] transition shadow-lg mt-4 cursor-pointer active:scale-95">ç¢ºèªæª”æœŸä¸¦å ±åƒ¹ <i class="fas fa-search ml-2"></i></button>
                        </form>
                    </div>

                    <div id="step2" class="hidden mt-6 border-t border-zinc-700 pt-6 animate-fade-in-down">
                        <div class="bg-zinc-800/80 p-4 rounded-xl border-l-4 border-green-500 mb-4">
                            <h4 class="text-green-400 font-bold text-lg mb-1"><i class="fas fa-check-circle"></i> æ–¹æ¡ˆåŸºç¤è²»ç”¨ï¼š$<span id="basePriceDisplay"></span></h4>
                            <div class="mt-3 border-t border-zinc-600 pt-3">
                                <p class="text-xs text-gray-400 mb-1">âœ… æ–¹æ¡ˆå…§å« (è‡ªå‹•é¸å–/æŠ˜æŠµ)ï¼š</p>
                                <ul id="includedFeatures" class="text-sm text-gray-300 list-disc list-inside space-y-1"></ul>
                            </div>
                        </div>
                        
                        <h3 class="text-white font-bold mb-4 flex items-center text-lg mt-6"><span class="bg-neon-pink text-white text-xs px-2 py-1 rounded mr-3">åŠ è³¼</span> å°ˆå±¬æœå‹™é¸å–®</h3>
                        <div class="grid grid-cols-1 gap-3 mb-6" id="addonList"></div>
                        
                        <button onclick="expandFinal()" class="w-full bg-neon-pink text-white font-bold py-3 rounded-lg hover:bg-pink-600 transition shadow-[0_0_15px_rgba(255,0,85,0.4)]">è¨ˆç®—ç¸½åƒ¹ <i class="fas fa-calculator ml-2"></i></button>
                    </div>

                    <div id="step3" class="hidden mt-6 border-t border-zinc-700 pt-6 animate-fade-in-down">
                        <div class="bg-white text-black p-5 rounded-xl shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-neon-blue to-neon-pink"></div>
                            <h4 class="font-bold text-xl mb-4 border-b border-gray-200 pb-2 text-center">é ç´„è©¦ç®—çµæœ</h4>
                            
                            <div class="space-y-3 text-sm mb-4">
                                <div class="flex justify-between items-center"><span class="text-gray-600 font-bold">é ç´„æ–¹æ¡ˆ</span><span id="invPlanName" class="font-bold text-right"></span></div>
                                <div class="flex justify-between items-center text-gray-500 text-xs"><span></span><span id="invPlanPrice"></span></div>
                                <div class="flex justify-between items-center border-t border-gray-200 pt-2"><span class="text-gray-600 font-bold">é ç´„æ—¥æœŸ</span><span id="invDate" class="font-bold text-right text-xs"></span></div>
                                <div class="flex justify-between items-center text-gray-500 text-xs"><span>æ™‚æ®µ</span><span id="invTimeRange"></span></div>
                            </div>
                            
                            <div class="bg-gray-100 p-3 rounded-lg mb-4">
                                <p class="text-xs text-gray-500 mb-2 font-bold uppercase">åŠ è³¼/å‡ç´šé …ç›®</p>
                                <ul id="invAddons" class="text-sm space-y-2"></ul>
                            </div>

                            <div class="flex justify-between items-end border-t border-gray-300 pt-4 mb-6">
                                <span class="text-gray-600 font-bold text-lg">é ä¼°ç¸½åƒ¹</span>
                                <span id="invTotal" class="text-3xl font-bold text-neon-pink"></span>
                            </div>

                            <div class="border-t-2 border-dashed border-gray-300 pt-4 mt-4">
                                <h5 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fas fa-user-edit mr-2"></i> é ç´„äººè³‡æ–™</h5>
                                <div class="mb-3">
                                    <label class="block text-gray-500 text-xs font-bold mb-1">æ‚¨çš„å§“å</label>
                                    <input type="text" id="guestName" class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-sm text-black" placeholder="ä¾‹ï¼šé™³å…ˆç”Ÿ">
                                </div>
                                <div>
                                    <label class="block text-gray-500 text-xs font-bold mb-1">è¯çµ¡é›»è©±</label>
                                    <input type="tel" id="guestPhone" maxlength="10" class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-sm text-black" placeholder="09xxxxxxxx">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 pb-4">
                            <button onclick="sendFinalToLine()" class="w-full bg-[#06c755] text-white font-bold py-4 rounded-lg hover:bg-[#05b54d] transition shadow-lg flex items-center justify-center text-xl animate-pulse"><i class="fab fa-line text-3xl mr-3"></i> ç¢ºèªå‚³é€é ç´„</button>
                            <p class="text-center text-gray-500 text-xs mt-2">*é€å‡ºå¾Œå°‡è‡ªå‹•é–‹å•Ÿ LINE è¦–çª—</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="copySuccessModal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="bg-zinc-800 border-2 border-[#06c755] p-8 rounded-2xl shadow-[0_0_50px_rgba(6,199,85,0.3)] text-center max-w-sm mx-4">
            <div class="w-20 h-20 bg-[#06c755] rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-check text-4xl text-white"></i></div>
            <h3 class="text-2xl font-bold text-white mb-2">é ç´„è³‡æ–™å·²è¤‡è£½ï¼</h3>
            <p class="text-gray-300 mb-8 text-sm">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å•Ÿ LINEï¼Œä¸¦åœ¨å°è©±æ¡†ä¸­ <span class="text-[#06c755] font-bold">è²¼ä¸Š</span> å‰›å‰›è¤‡è£½çš„æ–‡å­—ã€‚</p>
            <button onclick="goToLine()" class="w-full bg-[#06c755] hover:bg-[#05b54d] text-white font-bold py-4 rounded-xl text-lg transition shadow-lg">å‰å¾€ LINE è²¼ä¸Š <i class="fas fa-external-link-alt ml-2"></i></button>
            <button onclick="closeCopyModal()" class="mt-4 text-gray-500 text-sm underline">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <a href="javascript:void(0)" onclick="goToLine()" class="sticky-btn" aria-label="Lineæ´½è©¢"><i class="fa-brands fa-line"></i></a>

    <script>
        // â˜…â˜…â˜… æ‚¨çš„ GAS å¾Œç«¯ç¶²å€ â˜…â˜…â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzk5VWXvgDJLoLW_eTYuXIxh_ziCrD9mbRsvtrK-Aulasx4eMt6QT9mzuq3HeQ8UGspxw/exec";
        
        const LINE_ID = "@529ldsir"; 
        const LINE_DEEP_LINK = "line://ti/p/" + LINE_ID;

        // å…¨åŸŸè³‡æ–™åº« (ç¨å¾Œå¾ GAS å¡«å……)
        let PLANS_DB = {};
        let ADDONS_DB = [];
        let CONFIG_DB = {};
        
        let currentPlan = null;
        let selectedAddons = new Set();
        let addonQuantities = {};
        let bookingData = {};
        let isWeekend = false;
        let currentSlotMode = '';

        // ç³»çµ±åˆå§‹åŒ–
        window.onload = function() {
            fetchData();
            initCustomTimeSelects();
        };

        // 1. å¾æ‚¨çš„ Google Sheet æŠ“å–è³‡æ–™
        function fetchData() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'success') {
                        PLANS_DB = data.plans;
                        ADDONS_DB = data.addons;
                        CONFIG_DB = data.config;
                        console.log("Database Loaded Successfully");
                        document.getElementById('loadingOverlay').classList.add('hidden');
                    } else {
                        alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                    document.getElementById('loadingOverlay').classList.add('hidden');
                });
        }

        // 2. é¡¯ç¤ºå­æ–¹æ¡ˆ (å©šç¦®é¸å–®)
        function showSubPlanModal(planIds) {
            const container = document.getElementById('subPlanContainer');
            container.innerHTML = '';
            
            let hasValidPlan = false;
            planIds.forEach(id => {
                const plan = PLANS_DB[id];
                if(plan) {
                    hasValidPlan = true;
                    const btn = document.createElement('div');
                    btn.className = "w-full bg-zinc-800 border border-zinc-600 text-white p-5 rounded-lg cursor-pointer hover:bg-zinc-700 hover:border-neon-pink transition group shadow-lg";
                    
                    let featuresHtml = '';
                    if(plan.features && plan.features.length > 0) {
                        featuresHtml = plan.features.map(f => `<li class="flex items-start"><i class="fas fa-check text-neon-blue mt-1 mr-2 text-xs"></i><span class="text-sm text-gray-300">${f}</span></li>`).join('');
                    }

                    btn.innerHTML = `
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-zinc-600">
                            <span class="font-bold text-xl group-hover:text-neon-pink transition">${plan.name}</span>
                        </div>
                        <ul class="space-y-1">${featuresHtml}</ul>
                    `;
                    btn.onclick = () => confirmPlan(plan.id);
                    container.appendChild(btn);
                }
            });

            if(hasValidPlan) {
                document.getElementById('subPlanModal').classList.remove('hidden');
            } else {
                alert("ç›®å‰ç„¡æ³•è®€å–æ­¤æ–¹æ¡ˆè©³æƒ…ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }

        // 3. é»æ“Šä¸€èˆ¬å¡ç‰‡
        function handleCardClick(planId) {
            if(PLANS_DB[planId]) {
                confirmPlan(planId);
            } else {
                console.warn("Plan not found:", planId);
            }
        }

        // 4. ç¢ºèªæ–¹æ¡ˆ -> é–‹å•Ÿé ç´„è¦–çª—
        function confirmPlan(planId) {
            currentPlan = PLANS_DB[planId];
            
            document.getElementById('selectedPlanDisplay').innerText = currentPlan.name;
            document.getElementById('subPlanModal').classList.add('hidden');
            document.getElementById('bookingModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ²å‹•

            // é‡ç½® UI
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('dateInput').value = "";
            document.getElementById('basePriceDisplay').innerText = "";
            document.getElementById('dayTypeLabel').innerText = "";
            
            selectedAddons.clear();
            addonQuantities = {};
            currentSlotMode = '';
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));

            // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œå…¨æ—¥ã€æŒ‰éˆ• (åƒ…ç´”ç§Ÿå€Ÿèˆ‡æœƒè­°)
            if (currentPlan.id === 'rental' || currentPlan.id === 'meeting') {
                document.getElementById('btnAllDay').classList.remove('hidden');
            } else {
                document.getElementById('btnAllDay').classList.add('hidden');
            }
            
            // è¨­å®šæ—¥æœŸé™åˆ¶ (å‰ç½®æœŸ)
            const today = new Date();
            const leadDays = (currentPlan.id === 'rental' || currentPlan.id === 'meeting') ? 2 : 14;
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + leadDays);
            document.getElementById("dateInput").min = minDate.toISOString().split('T')[0];
        }

        function closeModal() { document.getElementById('bookingModal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        function closeSubModal() { document.getElementById('subPlanModal').classList.add('hidden'); }

        // 5. æ™‚æ®µèˆ‡æ—¥æœŸé‚è¼¯
        function selectSlot(mode) {
            currentSlotMode = mode;
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
            if(mode === 'lunch') document.getElementById('btnLunch').classList.add('active');
            if(mode === 'dinner') document.getElementById('btnDinner').classList.add('active');
            if(mode === 'allday') document.getElementById('btnAllDay').classList.add('active');
            checkLogic();
        }

        function customTimeTrigger() {
            currentSlotMode = 'custom';
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
            updateEndTime();
        }

        function checkLogic() {
            const dateVal = document.getElementById('dateInput').value;
            if(!dateVal) return;
            
            const d = new Date(dateVal);
            const day = d.getDay();
            // å‡æ—¥å®šç¾©ï¼šé€±å…­(6)ã€é€±æ—¥(0)ã€é€±äº”(5)æ™šå ´
            isWeekend = (day === 6 || day === 0);
            if (day === 5) {
                if (currentSlotMode === 'dinner') isWeekend = true;
                const startVal = document.getElementById('startTime').value;
                if(currentSlotMode === 'custom' && startVal) {
                    if(parseInt(startVal.split(':')[0]) >= 16) isWeekend = true;
                }
            }

            // é è¦½åƒ¹æ ¼ (åƒ…ä¾›åƒè€ƒ)
            document.getElementById('dayTypeLabel').innerText = `${isWeekend?"å‡æ—¥":"å¹³æ—¥"}è¨ˆåƒ¹`;
        }

        // 6. é»æ“Šã€Œç¢ºèªæª”æœŸã€ -> é€²å…¥ Step 2 (é¡¯ç¤ºæ¨™é…èˆ‡åŠ è³¼)
        function handleCheck(e) {
            e.preventDefault();
            const dateVal = document.getElementById('dateInput').value;
            if(!dateVal || !currentSlotMode) { alert("è«‹é¸æ“‡æ—¥æœŸèˆ‡æ™‚æ®µ"); return; }
            
            checkLogic(); // å†æ¬¡ç¢ºèªå¹³å‡æ—¥
            
            // è¨ˆç®—åŸºç¤åƒ¹æ ¼
            let basePrice = isWeekend ? currentPlan.priceWeekend : currentPlan.priceWeekday;
            if(currentSlotMode === 'allday') {
                // è‹¥å…¨æ—¥åŒ…å ´ï¼Œåƒ¹æ ¼å¯èƒ½ä¸åŒï¼Œé€™è£¡å…ˆåšç°¡å–®åŠ ä¹˜æˆ–å›ºå®šåƒ¹ (ä¾ Sheet è¨­å®šç‚ºä¸»ï¼Œæ­¤ç‚º fallback)
                // å‡è¨­ rental å…¨æ—¥æœ‰å„ªæƒ åƒ¹ï¼Œå…¶ä»–æ–¹æ¡ˆé›™å€
                if(currentPlan.id === 'rental') basePrice = isWeekend ? 36000 : 20000; 
                else basePrice = basePrice * 2; 
            }
            
            document.getElementById('basePriceDisplay').innerText = basePrice.toLocaleString();
            
            // æ¸²æŸ“ Step 2 å…§å®¹
            renderIncludedFeatures();
            renderAddons();

            document.getElementById('step2').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function renderIncludedFeatures() {
            const list = document.getElementById('includedFeatures');
            list.innerHTML = '';
            
            // é€šç”¨æ¨™é… (è®€å– Config)
            const chairs = CONFIG_DB.global_chairs || 25;
            list.innerHTML += `<li class="text-white font-bold">é€šç”¨ï¼šç«¹ç¯€æ¤… ${chairs}å¼µã€200å‹æŠ•å½±ã€éŸ³éŸ¿éº¥å…‹é¢¨</li>`;
            
            // æ–¹æ¡ˆæ¨™é…
            if(currentPlan.includes && currentPlan.includes.length > 0) {
                currentPlan.includes.forEach(incId => {
                    const item = ADDONS_DB.find(a => a.id === incId);
                    if(item) {
                        list.innerHTML += `<li class="text-neon-pink">${item.name}</li>`;
                    }
                });
            }
        }

        // â˜…â˜…â˜… æ ¸å¿ƒé‚è¼¯ï¼šæ¸²æŸ“åŠ è³¼æ¸…å–® (å«äº’æ–¥/å‡ç´šåˆ¤æ–·) â˜…â˜…â˜…
        function renderAddons() {
            const container = document.getElementById('addonList');
            container.innerHTML = '';
            
            const planIncludes = new Set(currentPlan.includes || []);
            
            ADDONS_DB.forEach(addon => {
                // 1. å¦‚æœæ–¹æ¡ˆå·²åŒ…å«æ­¤ ID -> éš±è—åŠ è³¼ (é¿å…é‡è¤‡è²·)
                // ä¾‹å¤–ï¼štable_6 è‹¥æ–¹æ¡ˆå«ï¼Œæˆ‘å€‘å¸Œæœ›é¡¯ç¤ºç‚ºã€Œé¡å¤–åŠ ç§Ÿã€ï¼Œä½†é€™é‚Šå…ˆç°¡åŒ–ç‚ºä¸é¡¯ç¤ºï¼Œç”±å®¢äººè‡ªå·±åŠ ã€Œæ¡Œå­(å–®ç§Ÿ)ã€
                if(planIncludes.has(addon.id)) return;

                // 2. è™•ç† Logic Tag (Google Sheet è¨­å®šçš„è¦å‰‡)
                if(addon.logicTag) {
                    // conflict:xxx -> è‹¥æ–¹æ¡ˆå« xxx å‰‡éš±è—æ­¤é …
                    if(addon.logicTag.startsWith('conflict:')) {
                        const conflictId = addon.logicTag.split(':')[1];
                        if(planIncludes.has(conflictId)) return;
                    }
                    // require:xxx -> è‹¥æ–¹æ¡ˆå« xxx æ‰é¡¯ç¤º (ä¾‹å¦‚å‡ç´šé¸é …)
                    if(addon.logicTag.startsWith('require:')) {
                        const reqId = addon.logicTag.split(':')[1];
                        if(!planIncludes.has(reqId)) return;
                    }
                    // hide_if:xxx -> è‹¥æ–¹æ¡ˆå« xxx å‰‡éš±è— (ä¾‹å¦‚æœ‰DJå°±ä¸èƒ½é¸åŠ è³¼DJï¼Œåªèƒ½é¸å‡ç´šæ­Œæ‰‹)
                    if(addon.logicTag.startsWith('hide_if:')) {
                        const hideId = addon.logicTag.split(':')[1];
                        if(planIncludes.has(hideId)) return;
                    }
                }

                // 3. æ¸²æŸ“æŒ‰éˆ•
                const price = isWeekend ? addon.priceWeekend : addon.priceWeekday;
                const div = document.createElement('div');
                
                if(addon.type === 'counter') {
                    // è¨ˆæ•¸å™¨ UI
                    const qty = addonQuantities[addon.id] || 0;
                    const activeClass = qty > 0 ? 'border-neon-blue bg-zinc-800' : 'border-zinc-600';
                    const priceColor = qty > 0 ? 'text-neon-blue' : 'text-gray-400';
                    
                    div.className = `addon-btn bg-black border ${activeClass} rounded-lg p-3 flex justify-between items-center transition select-none`;
                    div.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-white">${addon.name}</span>
                            <span class="text-xs text-gray-500">$${price}/${addon.unit}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="counter-btn" onclick="updateCounter('${addon.id}', -1, ${addon.min}, ${addon.max})"><i class="fas fa-minus text-white text-xs"></i></div>
                            <span id="count_${addon.id}" class="text-white font-bold w-6 text-center">${qty}</span>
                            <div class="counter-btn" onclick="updateCounter('${addon.id}', 1, ${addon.min}, ${addon.max})"><i class="fas fa-plus text-white text-xs"></i></div>
                        </div>
                    `;
                } else {
                    // é–‹é—œ UI
                    const isSel = selectedAddons.has(addon.id);
                    const activeClass = isSel ? 'border-neon-blue bg-zinc-800' : 'border-zinc-600 hover:bg-zinc-800';
                    const iconClass = isSel ? 'opacity-100 bg-neon-blue text-black border-neon-blue' : 'opacity-30 border-zinc-500';
                    
                    div.className = `addon-btn bg-black border ${activeClass} rounded-lg p-3 flex justify-between items-center cursor-pointer transition select-none`;
                    div.onclick = () => toggleAddon(addon.id);
                    div.innerHTML = `
                        <div class="flex items-center">
                            <div class="check-icon w-5 h-5 rounded-full border ${iconClass} mr-3 flex items-center justify-center transition-all"><i class="fas fa-check text-[10px]"></i></div>
                            <span class="text-sm font-bold text-white">${addon.name}</span>
                        </div>
                        <span class="${isSel ? 'text-neon-pink' : 'text-gray-400'} text-sm font-bold">$${price}</span>
                    `;
                }
                container.appendChild(div);
            });
        }

        // UI äº’å‹•å‡½æ•¸
        function updateCounter(id, delta, min, max) {
            let current = addonQuantities[id] || 0;
            let next = current + delta;
            
            // Min é‚è¼¯è™•ç† (å¾0åŠ æ™‚ç›´æ¥è·³ Min)
            if(min > 0) {
                if(current === 0 && delta > 0) next = min;
                else if(current === min && delta < 0) next = 0;
                else if(next < min && next > 0) next = min;
            }
            
            if(next < 0) next = 0;
            if(next > max) { alert(`æ­¤é …ç›®ä¸Šé™ç‚º ${max}`); next = max; }
            
            addonQuantities[id] = next;
            renderAddons(); // åˆ·æ–° UI ç‹€æ…‹
        }

        function toggleAddon(id) {
            if(selectedAddons.has(id)) selectedAddons.delete(id);
            else selectedAddons.add(id);
            renderAddons();
        }

        // 7. è¨ˆç®—ç¸½åƒ¹ -> é€²å…¥ Step 3
        function expandFinal() {
            let basePrice = isWeekend ? currentPlan.priceWeekend : currentPlan.priceWeekday;
            if(currentSlotMode === 'allday' && currentPlan.id === 'rental') basePrice = isWeekend ? 36000 : 20000;
            // åŒ…å¥—å…¨æ—¥å…ˆç²—æŠ“ x2 (è‹¥æœ‰éœ€è¦å¯å†ç²¾ä¿®)
            if(currentSlotMode === 'allday' && currentPlan.id !== 'rental') basePrice = basePrice * 2;

            let addonTotal = 0;
            const invAddons = document.getElementById('invAddons');
            invAddons.innerHTML = '';

            // è¨ˆç®—è¨ˆæ•¸é …ç›®
            for (const [id, qty] of Object.entries(addonQuantities)) {
                if (qty > 0) {
                    const item = ADDONS_DB.find(a => a.id === id);
                    if(item) {
                        const price = isWeekend ? item.priceWeekend : item.priceWeekday;
                        const sub = price * qty;
                        addonTotal += sub;
                        invAddons.innerHTML += `<li class="flex justify-between border-b border-gray-200 pb-1"><span>${item.name} x ${qty}</span><span>$${sub.toLocaleString()}</span></li>`;
                    }
                }
            }

            // è¨ˆç®—é–‹é—œé …ç›®
            selectedAddons.forEach(id => {
                const item = ADDONS_DB.find(a => a.id === id);
                if(item) {
                    const price = isWeekend ? item.priceWeekend : item.priceWeekday;
                    addonTotal += price;
                    invAddons.innerHTML += `<li class="flex justify-between border-b border-gray-200 pb-1"><span>${item.name}</span><span>$${price.toLocaleString()}</span></li>`;
                }
            });

            if(invAddons.innerHTML === '') invAddons.innerHTML = '<li class="text-gray-400 italic">ç„¡åŠ è³¼é …ç›®</li>';

            const total = basePrice + addonTotal;
            document.getElementById('invPlanName').innerText = currentPlan.name;
            document.getElementById('invPlanPrice').innerText = `$${basePrice.toLocaleString()}`;
            document.getElementById('invDate').innerText = `${document.getElementById('dateInput').value} ${isWeekend?"(å‡æ—¥)":"(å¹³æ—¥)"}`;
            
            // æ™‚é–“å­—ä¸²æ•´ç†
            let timeStr = "";
            if(currentSlotMode === 'lunch') timeStr = "11:00-14:00";
            else if(currentSlotMode === 'dinner') timeStr = "17:00-20:00";
            else if(currentSlotMode === 'allday') timeStr = "09:00-21:00";
            else {
                const start = document.getElementById('startTime').value;
                const end = document.getElementById('endTimeDisplay').value.split(' ')[0];
                timeStr = `${start}-${end}`;
            }
            document.getElementById('invTimeRange').innerText = timeStr;
            document.getElementById('invTotal').innerText = `NT$ ${total.toLocaleString()}`;

            // å„²å­˜è³‡æ–™ä¾›ç™¼é€
            bookingData = {
                planName: currentPlan.name,
                date: document.getElementById('dateInput').value,
                time: timeStr,
                total: total,
                details: invAddons.innerHTML
            };

            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('step3').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 8. ç™¼é€è‡³ LINE
        function sendFinalToLine() {
            const name = document.getElementById('guestName').value;
            const phone = document.getElementById('guestPhone').value;
            if(!name || !phone) { alert("è«‹å¡«å¯«å§“åèˆ‡é›»è©±"); return; }

            // ç”¢ç”Ÿç´”æ–‡å­—å ±è¡¨
            let detailsText = "";
            for (const [id, qty] of Object.entries(addonQuantities)) {
                if (qty > 0) {
                    const item = ADDONS_DB.find(a => a.id === id);
                    if(item) detailsText += `- ${item.name} x ${qty} ${item.unit}\n`;
                }
            }
            selectedAddons.forEach(id => {
                const item = ADDONS_DB.find(a => a.id === id);
                if(item) detailsText += `- ${item.name}\n`;
            });
            if(detailsText === "") detailsText = "ç„¡\n";

            // æ–¹æ¡ˆæ¨™é…ä¹Ÿåˆ—å‡ºä¾†æ¯”è¼ƒæ¸…æ¥š
            let includesText = "";
            if(currentPlan.includes && currentPlan.includes.length > 0) {
                currentPlan.includes.forEach(incId => {
                    const item = ADDONS_DB.find(a => a.id === incId);
                    if(item) includesText += `- ${item.name} (å…§å«)\n`;
                });
            }

            let msg = `æ‚¨å¥½ï¼æˆ‘æƒ³é ç´„ RUINS BAR ğŸ¥‚\n\n`;
            msg += `ğŸ‘¤ å§“åï¼š${name}\nğŸ“± é›»è©±ï¼š${phone}\n------------------------\n`;
            msg += `ğŸ“… æ—¥æœŸï¼š${bookingData.date} ${isWeekend?"(å‡æ—¥)":"(å¹³æ—¥)"}\n`;
            msg += `â° æ™‚æ®µï¼š${bookingData.time}\n`;
            msg += `ğŸ“‹ æ–¹æ¡ˆï¼š${bookingData.planName}\n\n`;
            msg += `âœ… æ–¹æ¡ˆå…§å«ï¼š\n${includesText}\n`;
            msg += `â• åŠ è³¼/å‡ç´šï¼š\n${detailsText}\n`;
            msg += `ğŸ’° é ä¼°ç¸½åƒ¹ï¼šNT$ ${bookingData.total.toLocaleString()}\n`;
            msg += `\nè«‹å”åŠ©ç¢ºèªæª”æœŸï¼Œè¬è¬ï¼`;

            // è¤‡è£½ä¸¦è·³è½‰
            copyToClipboard(msg).then(() => {
                document.getElementById('copySuccessModal').classList.remove('hidden');
                closeModal();
            });
        }

        // å·¥å…·ï¼šåˆå§‹åŒ–è‡ªè¨‚æ™‚é–“é¸å–® (09:00 - 23:00)
        function initCustomTimeSelects() {
            const s = document.getElementById('startTime');
            for (let i = 18; i <= 46; i++) { 
                const hour = Math.floor(i / 2);
                const min = (i % 2) === 0 ? '00' : '30';
                const t = `${hour < 10 ? '0'+hour : hour}:${min}`;
                s.add(new Option(t, t));
            }
        }
        function updateEndTime() {
            const startVal = document.getElementById('startTime').value;
            if(!startVal) return;
            const [h, m] = startVal.split(':').map(Number);
            let endH = h + 3; // é è¨­ 3hr
            let suffix = "";
            if(endH >= 24) { endH -= 24; suffix = "(+1)"; }
            const t = `${endH < 10 ? '0'+endH : endH}:${m===0?'00':m}${suffix}`;
            document.getElementById('endTimeDisplay').value = t + " (3hr)";
        }
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                // Fallback for older browsers
                let textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try { document.execCommand('copy'); } catch (err) {}
                document.body.removeChild(textArea);
                return Promise.resolve();
            }
        }
        function goToLine() { window.location.href = LINE_DEEP_LINK; }
        function closeCopyModal() { document.getElementById('copySuccessModal').classList.add('hidden'); }
    </script>
</body>
</html>
