<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruins Bar 高雄廢墟場地租借 | 預約系統</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&family=Oswald:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ruin-dark': '#121212',
                        'ruin-gray': '#1e1e1e',
                        'neon-pink': '#ff0055',
                        'neon-blue': '#00f3ff',
                        'champagne': '#d4af37',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                        display: ['"Oswald"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #121212; color: #e0e0e0; }
        input[type="date"] { position: relative; font-size: 1.1rem; }
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .addon-btn.selected { border-color: #00f3ff; background-color: rgba(0, 243, 255, 0.1); color: white; }
        .addon-btn.selected .check-icon { opacity: 1; background-color: #00f3ff; color: black; }
        .addon-btn.included { border-color: #06c755; background-color: rgba(6, 199, 85, 0.1); color: #88ffaa; cursor: default; }
        .addon-btn.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(100%); display: none; } 
        
        .plan-card { transition: all 0.3s ease; }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
        .plan-card:hover img { transform: scale(1.05); }
        .plan-card img { transition: transform 0.8s ease; }

        .sticky-btn { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background-color: #06c755; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 40; transition: all 0.3s ease; text-decoration: none; cursor: pointer; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(6, 199, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(6, 199, 85, 0); } }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .counter-btn { width: 30px; height: 30px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .counter-btn:hover { background: #555; }

        .slot-btn { background-color: #1a1a1a; border: 1px solid #444; color: #888; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .slot-btn:hover { border-color: #666; color: white; }
        .slot-btn.active { background-color: rgba(0, 243, 255, 0.15); border-color: #00f3ff; color: #00f3ff; font-weight: bold; box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        .slot-btn.disabled { opacity: 0.3; cursor: not-allowed; border-color: #333; color: #444; }
        
        #loadingOverlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); transition: opacity 0.5s; }
        .hidden { display: none !important; }

        .menu-category { color: #d4af37; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 1rem; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .menu-checkbox-item { display: flex; align-items: center; margin-bottom: 8px; padding: 5px; border-radius: 5px; transition: background 0.2s; }
        .menu-checkbox-item:hover { background-color: #333; }
        .menu-checkbox-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: #00f3ff; margin-right: 10px; cursor: pointer; }
        .menu-checkbox-item label { cursor: pointer; font-size: 0.9rem; color: #ddd; flex-grow: 1; }
    </style>
</head>
<body class="font-sans antialiased selection:bg-neon-pink selection:text-white pb-24">

    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-neon-pink mb-4"></div>
        <p class="text-white text-lg font-bold">正在讀取最新方案...</p>
        <p class="text-gray-400 text-sm mt-2">Connecting to Google Database</p>
    </div>

    <nav class="fixed w-full z-50 bg-ruin-dark/95 backdrop-blur-md border-b border-white/10 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="font-display text-2xl font-bold tracking-wider text-white">RUINS <span class="text-neon-pink">BAR</span></span>
                </div>
                <div class="hidden lg:block">
                    <div class="ml-10 flex items-baseline space-x-6">
                        <a href="#plans-section" class="text-neon-blue hover:text-white transition px-3 py-2 rounded-md text-sm font-bold border border-neon-blue cursor-pointer"><i class="fas fa-calendar-check mr-1"></i> 方案預約</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative bg-ruin-gray h-screen flex items-center justify-center overflow-hidden">
        <div class="absolute inset-0 z-0 opacity-40 bg-cover bg-center grayscale" style="background-image: url('images/cover-bg.jpg');"></div>
        <div class="absolute inset-0 bg-gradient-to-t from-ruin-dark via-transparent to-ruin-dark z-10"></div>
        <div class="relative z-20 text-center px-4">
            <h1 class="font-display text-5xl md:text-7xl font-bold text-white mb-4 tracking-widest neon-text-pink">INDUSTRIAL RUINS</h1>
            <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-2xl mx-auto font-light">高雄鹽埕 × 廢墟美學 × 極致派對體驗</p>
            <a href="#plans-section" class="inline-block bg-neon-pink text-white font-bold py-4 px-10 rounded-full hover:bg-pink-600 transition duration-300 shadow-[0_0_20px_rgba(255,0,85,0.5)] cursor-pointer">
                開始預約旅程
            </a>
        </div>
    </div>

    <section id="plans-section" class="py-20 px-4 bg-ruin-dark relative z-30">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-white mb-10 text-center flex items-center justify-center"><i class="fas fa-list-ul text-neon-blue mr-3"></i> 選擇您的活動方案</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
                <div onclick="handleCardClick('proposal')" class="plan-card cursor-pointer group relative rounded-2xl overflow-hidden border-2 border-neon-pink/50 shadow-[0_0_30px_rgba(255,0,85,0.15)] hover:border-neon-pink bg-zinc-900 flex flex-col">
                    <div class="h-80 md:h-96 overflow-hidden relative w-full">
                        <img src="images/proposal-cover.jpg" onerror="this.src='https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?auto=format&fit=crop&q=80&w=1000'" class="w-full h-full object-cover">
                        <div class="absolute bottom-6 left-8 z-10">
                            <div class="text-white font-bold text-2xl mb-1 flex items-center"><i class="fas fa-heart text-neon-pink mr-3"></i> 浪漫求婚派對</div>
                        </div>
                    </div>
                    <div class="p-8 flex-grow flex flex-col justify-between">
                        <p class="text-gray-300 mb-4 text-base leading-relaxed">包含 Merry ME 燈條佈置、求婚花束。</p>
                        <div class="text-right text-neon-pink font-bold group-hover:translate-x-2 transition mt-4">查看方案 <i class="fas fa-arrow-right ml-1"></i></div>
                    </div>
                </div>

                <div onclick="showSubPlanModal(['wedding_A', 'wedding_B'], '選擇婚禮方案')" class="plan-card wedding-card cursor-pointer group relative rounded-2xl overflow-hidden border-2 border-champagne/50 shadow-[0_0_30px_rgba(212,175,55,0.15)] bg-zinc-900 flex flex-col">
                    <div class="h-80 md:h-96 overflow-hidden relative w-full">
                        <img src="images/wedding-cover.jpg" onerror="this.src='https://images.unsplash.com/photo-1511795409834-ef04bbd61622?auto=format&fit=crop&q=80&w=1000'" class="w-full h-full object-cover">
                        <div class="absolute bottom-6 left-8 z-10">
                            <div class="text-white font-bold text-2xl mb-1 flex items-center"><i class="fas fa-ring text-champagne mr-3"></i> 婚禮派對 & 證婚</div>
                        </div>
                    </div>
                    <div class="p-8 flex-grow flex flex-col justify-between">
                        <p class="text-gray-300 mb-4 text-base leading-relaxed">Welcome Party / 戶外證婚包場，打造獨一無二的婚禮體驗。</p>
                        <div class="text-right text-champagne font-bold group-hover:translate-x-2 transition mt-4">查看詳細 <i class="fas fa-arrow-right ml-1"></i></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div onclick="handleCardClick('rental')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1"><i class="fas fa-building mr-2 text-gray-400"></i>純場地租借</h4>
                    <p class="text-gray-500 text-xs">僅含基本桌椅 (3hr起)</p>
                </div>

                <div onclick="handleCardClick('meeting')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1"><i class="fas fa-briefcase mr-2 text-gray-400"></i>會議包場方案</h4>
                    <p class="text-gray-500 text-xs">含桌椅、投影、茶水</p>
                </div>

                <div onclick="showSubPlanModal(['baby', 'gender', 'party'], '選擇派對類型')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1"><i class="fas fa-birthday-cake mr-2 text-neon-pink"></i>各式派對方案</h4>
                    <p class="text-gray-500 text-xs">抓周 / 性別派對 / 慶生</p>
                </div>
                
                <div onclick="handleCardClick('custom')" class="plan-card bg-zinc-900 border border-zinc-700 rounded-xl overflow-hidden cursor-pointer p-4 hover:border-neon-blue">
                    <h4 class="text-lg font-bold text-white mb-1"><i class="fas fa-magic mr-2 text-neon-blue"></i>訂製客製化專屬方案</h4>
                    <p class="text-gray-500 text-xs">依場地基本費，自由加購</p>
                </div>
            </div>
        </div>
    </section>

    <div id="subPlanModal" class="hidden fixed inset-0 z-[70] overflow-y-auto" role="dialog">
        <div class="fixed inset-0 bg-black/90 transition-opacity backdrop-blur-sm" onclick="closeSubModal()"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-zinc-900 text-left shadow-2xl w-full max-w-lg border border-zinc-700">
                <div class="p-6">
                    <h3 id="subPlanTitle" class="text-xl font-bold text-white mb-4 text-center"></h3>
                    <div id="subPlanContainer" class="space-y-4"></div>
                    <button onclick="closeSubModal()" class="mt-6 w-full text-gray-500 text-sm">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div id="menuModal" class="hidden fixed inset-0 z-[90] overflow-y-auto">
        <div class="fixed inset-0 bg-black/90 transition-opacity backdrop-blur-sm" onclick="closeMenuModal()"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative transform overflow-hidden rounded-2xl bg-zinc-900 text-left shadow-2xl w-full max-w-md border border-neon-blue/50">
                <div class="p-6 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="menuModalTitle" class="text-xl font-bold text-white"></h3>
                        <button onclick="closeMenuModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div id="menuInstruction" class="text-xs text-neon-pink mb-4 bg-zinc-800 p-3 rounded font-bold border border-neon-pink hidden"></div>

                    <form id="dynamicMenuForm" class="space-y-2"></form>
                    
                    <button onclick="closeMenuModal()" class="mt-6 w-full bg-zinc-700 text-white font-bold py-3 rounded-lg hover:bg-zinc-600 shadow-lg">確認並返回</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bookingModal" class="hidden fixed inset-0 z-[60] overflow-y-auto">
        <div class="fixed inset-0 bg-black/80 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-zinc-900 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-zinc-700">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10 p-2"><i class="fas fa-times text-2xl"></i></button>

                <div class="max-h-[85vh] overflow-y-auto p-6 scrollbar-hide">
                    <h3 class="text-center text-white font-bold mb-2 text-2xl flex justify-center items-center"><i class="fas fa-calendar-alt text-neon-blue mr-3"></i> 預約試算</h3>
                    <div class="bg-zinc-800 p-3 rounded-lg mb-6 text-center border border-zinc-700">
                        <span class="text-gray-400 text-xs block">您目前選擇的方案</span>
                        <span id="selectedPlanDisplay" class="text-neon-pink font-bold text-lg"></span>
                    </div>

                    <div id="step1">
                        <form id="checkForm" onsubmit="handleCheck(event)" class="space-y-4">
                            <div>
                                <label class="block text-neon-blue text-sm font-bold mb-1">1. 選擇預計日期</label>
                                <div class="relative"><input type="date" id="dateInput" onchange="handleDateSelect()" onclick="this.showPicker()" required class="w-full bg-black border border-zinc-700 text-white rounded-lg p-3 focus:border-neon-blue focus:outline-none cursor-pointer"></div>
                                <p id="dayTypeLabel" class="text-xs text-gray-500 mt-1 text-right"></p>
                            </div>
                            <div id="timeSelectionArea">
                                <label class="block text-neon-blue text-sm font-bold mb-1">2. 選擇時段</label>
                                <div class="grid grid-cols-3 gap-2 mb-4" id="standardSlots">
                                    <button type="button" onclick="selectSlot('lunch')" id="btnLunch" class="slot-btn py-2 rounded-lg text-sm font-bold">午場<br><span class="text-xs font-normal">11:00-14:00</span></button>
                                    <button type="button" onclick="selectSlot('dinner')" id="btnDinner" class="slot-btn py-2 rounded-lg text-sm font-bold">晚場<br><span class="text-xs font-normal">17:00-20:00</span></button>
                                    <button type="button" onclick="selectSlot('allday')" id="btnAllDay" class="slot-btn py-2 rounded-lg text-sm font-bold hidden">全日<br><span class="text-xs font-normal">09:00-21:00</span></button>
                                </div>
                                <div id="alldayWarning" class="hidden text-red-400 text-xs text-center mb-2">*週五不開放全日租借</div>
                                <div class="relative border-t border-zinc-700 pt-4 mt-2">
                                    <p class="text-xs text-gray-400 mb-2">或 自訂開始時間 (結束自動計算)</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-white text-xs">開始</label><select id="startTime" onchange="customTimeTrigger()" class="w-full bg-black border-zinc-600 text-white rounded p-1"></select></div>
                                        <div><label class="text-white text-xs">結束</label><input type="text" id="endTimeDisplay" readonly class="w-full bg-[#1a1a1a] border border-zinc-600 text-gray-400 rounded p-1 text-center" value="自動計算"><input type="hidden" id="endTime"></div>
                                    </div>
                                </div>
                            </div>
                            <button id="submitBtn" type="submit" class="w-full bg-neon-blue text-black font-bold py-3 rounded-lg hover:bg-[#00d0dd] transition shadow-lg mt-4 cursor-pointer active:scale-95">確認檔期並報價 <i class="fas fa-search ml-2"></i></button>
                        </form>
                    </div>

                    <div id="step2" class="hidden mt-6 border-t border-zinc-700 pt-6 animate-fade-in-down">
                        <div class="bg-zinc-800/80 p-4 rounded-xl border-l-4 border-green-500 mb-4">
                            <h4 class="text-green-400 font-bold text-lg mb-1"><i class="fas fa-check-circle"></i> 方案基礎費用：$<span id="basePriceDisplay"></span></h4>
                            <div class="mt-3 border-t border-zinc-600 pt-3">
                                <p class="text-xs text-gray-400 mb-1">✅ 方案內含 (自動選取/折抵)：</p>
                                <ul id="includedFeatures" class="text-sm text-gray-300 list-disc list-inside space-y-1"></ul>
                            </div>
                        </div>
                        
                        <h3 class="text-white font-bold mb-4 flex items-center text-lg mt-6"><span class="bg-neon-pink text-white text-xs px-2 py-1 rounded mr-3">加購</span> 專屬服務選單</h3>
                        <div class="grid grid-cols-1 gap-3 mb-6" id="addonList"></div>
                        
                        <button onclick="expandFinal()" class="w-full bg-neon-pink text-white font-bold py-3 rounded-lg hover:bg-pink-600 transition shadow-[0_0_15px_rgba(255,0,85,0.4)]">計算總價 <i class="fas fa-calculator ml-2"></i></button>
                    </div>

                    <div id="step3" class="hidden mt-6 border-t border-zinc-700 pt-6 animate-fade-in-down">
                        <div class="bg-white text-black p-5 rounded-xl shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-neon-blue to-neon-pink"></div>
                            <h4 class="font-bold text-xl mb-4 border-b border-gray-200 pb-2 text-center">預約試算結果</h4>
                            
                            <div class="space-y-3 text-sm mb-4">
                                <div class="flex justify-between items-center"><span class="text-gray-600 font-bold">預約方案</span><span id="invPlanName" class="font-bold text-right"></span></div>
                                <div class="flex justify-between items-center text-gray-500 text-xs"><span></span><span id="invPlanPrice"></span></div>
                                <div class="flex justify-between items-center border-t border-gray-200 pt-2"><span class="text-gray-600 font-bold">預約日期</span><span id="invDate" class="font-bold text-right text-xs"></span></div>
                                <div class="flex justify-between items-center text-gray-500 text-xs"><span>時段</span><span id="invTimeRange"></span></div>
                            </div>
                            
                            <div class="bg-gray-100 p-3 rounded-lg mb-4">
                                <p class="text-xs text-gray-500 mb-2 font-bold uppercase">加購/升級項目</p>
                                <ul id="invAddons" class="text-sm space-y-2"></ul>
                            </div>

                            <div class="flex justify-between items-end border-t border-gray-300 pt-4 mb-6">
                                <span class="text-gray-600 font-bold text-lg">預估總價</span>
                                <span id="invTotal" class="text-3xl font-bold text-neon-pink"></span>
                            </div>

                            <div class="border-t-2 border-dashed border-gray-300 pt-4 mt-4">
                                <h5 class="font-bold text-gray-700 mb-3 flex items-center"><i class="fas fa-user-edit mr-2"></i> 預約人資料</h5>
                                <div class="mb-3">
                                    <label class="block text-gray-500 text-xs font-bold mb-1">您的姓名</label>
                                    <input type="text" id="guestName" class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-sm text-black" placeholder="例：陳先生">
                                </div>
                                <div>
                                    <label class="block text-gray-500 text-xs font-bold mb-1">聯絡電話</label>
                                    <input type="tel" id="guestPhone" maxlength="10" class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-sm text-black" placeholder="09xxxxxxxx">
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 pb-4">
                            <button onclick="sendFinalToLine()" class="w-full bg-[#06c755] text-white font-bold py-4 rounded-lg hover:bg-[#05b54d] transition shadow-lg flex items-center justify-center text-xl animate-pulse"><i class="fab fa-line text-3xl mr-3"></i> 確認傳送預約</button>
                            <p class="text-center text-gray-500 text-xs mt-2">*送出後將自動開啟 LINE 視窗</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="copySuccessModal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <div class="bg-zinc-800 border-2 border-[#06c755] p-8 rounded-2xl shadow-[0_0_50px_rgba(6,199,85,0.3)] text-center max-w-sm mx-4">
            <div class="w-20 h-20 bg-[#06c755] rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-check text-4xl text-white"></i></div>
            <h3 class="text-2xl font-bold text-white mb-2">預約資料已複製！</h3>
            <p class="text-gray-300 mb-8 text-sm">請點擊下方按鈕開啟 LINE，並在對話框中 <span class="text-[#06c755] font-bold">貼上</span> 剛剛複製的文字。</p>
            <button onclick="goToLine()" class="w-full bg-[#06c755] hover:bg-[#05b54d] text-white font-bold py-4 rounded-xl text-lg transition shadow-lg">前往 LINE 貼上 <i class="fas fa-external-link-alt ml-2"></i></button>
            <button onclick="closeCopyModal()" class="mt-4 text-gray-500 text-sm underline">關閉視窗</button>
        </div>
    </div>

    <a href="javascript:void(0)" onclick="goToLine()" class="sticky-btn" aria-label="Line洽詢"><i class="fa-brands fa-line"></i></a>

    <script>
        // ==========================================
        // 請務必確認這裡的 GAS_URL 是您剛剛部署好的新網址
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzk5VWXvgDJLoLW_eTYuXIxh_ziCrD9mbRsvtrK-Aulasx4eMt6QT9mzuq3HeQ8UGspxw/exec";
        const LINE_ID = "@529ldsir"; 
        const LINE_DEEP_LINK = "line://ti/p/" + LINE_ID;

        // Data for Menus
        const MENUS = {
            'food': {
                title: '拼盤口味選擇',
                note: '請勾選您要的口味。<br>每一個勾選 = 加購「一盤 (25人份)」。',
                items: [
                    { category: '【鹹點區】', list: ['咖哩餃','義式玉米烤','鮪魚派','蘋果派','丹麥鮪魚','丹麥起司培根','黃金乳酪球(素)','丹麥煙雞(葷/素)','丹麥香腸(葷/素)','丹麥生菜沙拉(葷/素)','小沙拉堡(葷/素)','鮪魚餐包及小漢堡','菠蘿QQ球(素)','墨西哥雞肉捲','法式披薩(葷/素)','丹麥串燒(葷/素)','燒賣及珍珠丸','上海湯包','起酥香腸捲','港式蘿蔔糕','丹麥培根鳳梨','麥克雞塊'] },
                    { category: '【甜點區】', list: ['桂圓蛋糕','檸檬蛋糕','布丁水果塔','原味小蛋塔','蔓越莓小蛋塔','椰子塔','什錦水果塔','乳酪一口酥','黑森林蛋糕','乳酪蛋糕','提拉米蘇蛋糕','日式泡芙','手工餅乾','日式麻糬','船型杏仁核桃塔','蔓越莓泡芙','提拉米蘇杯'] }
                ]
            },
            'drink_700': {
                title: '無酒精飲品選擇 ($700/桶)',
                note: '請勾選您要的口味。<br>每一個勾選 = 加購「一桶 (5L)」。',
                items: [
                    { category: '【口味列表】', list: ['柳橙汁','蘋果醋','覆盆莓果茶','古早味紅茶','無糖綠茶','冬瓜檸檬'] }
                ]
            },
            'drink_1200': {
                title: '精選飲品/咖啡選擇 ($1200/桶)',
                note: '請勾選您要的口味。<br>每一個勾選 = 加購「一桶 (5L)」。',
                items: [
                    { category: '【口味列表】', list: ['泰式奶茶','紅茶牛奶','美式咖啡(冰)','美式咖啡(熱)','咖啡拿鐵'] }
                ]
            }
        };

        let PLANS_DB = {};
        let ADDONS_DB = [];
        let CONFIG_DB = {};
        
        let currentPlan = null;
        let selectedAddons = new Set();
        let addonQuantities = {};
        let bookingData = {};
        let isWeekend = false;
        let currentSlotMode = '';

        window.onload = function() {
            fetchData();
            initCustomTimeSelects();
        };

        function fetchData() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            fetch(GAS_URL)
                .then(res => res.json())
                .then(data => {
                    if(data.status === 'success') {
                        PLANS_DB = data.plans;
                        ADDONS_DB = data.addons;
                        CONFIG_DB = data.config;
                        document.getElementById('loadingOverlay').classList.add('hidden');
                    } else { alert("資料讀取失敗"); }
                })
                .catch(err => { alert("連線錯誤"); document.getElementById('loadingOverlay').classList.add('hidden'); });
        }

        function showSubPlanModal(planIds, title) {
            const container = document.getElementById('subPlanContainer');
            document.getElementById('subPlanTitle').innerText = title;
            container.innerHTML = '';
            let hasValidPlan = false;
            planIds.forEach(id => {
                const plan = PLANS_DB[id];
                if(plan) {
                    hasValidPlan = true;
                    const btn = document.createElement('div');
                    btn.className = "w-full bg-zinc-800 border border-zinc-600 text-white p-5 rounded-lg cursor-pointer hover:bg-zinc-700 hover:border-neon-pink transition group shadow-lg";
                    let featuresHtml = plan.features ? plan.features.map(f => `<li class="flex items-start"><i class="fas fa-check text-neon-blue mt-1 mr-2 text-xs"></i><span class="text-sm text-gray-300">${f}</span></li>`).join('') : '';
                    btn.innerHTML = `<div class="flex justify-between items-center mb-3 pb-2 border-b border-zinc-600"><span class="font-bold text-xl group-hover:text-neon-pink transition">${plan.name}</span></div><ul class="space-y-1">${featuresHtml}</ul>`;
                    btn.onclick = () => confirmPlan(plan.id);
                    container.appendChild(btn);
                }
            });
            if(hasValidPlan) document.getElementById('subPlanModal').classList.remove('hidden');
        }

        function handleCardClick(planId) { if(PLANS_DB[planId]) confirmPlan(planId); }

        function resetUI() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('dateInput').value = "";
            document.getElementById('basePriceDisplay').innerText = "";
            document.getElementById('dayTypeLabel').innerText = "";
            document.getElementById('includedFeatures').innerHTML = "";
            document.getElementById('addonList').innerHTML = "";
            selectedAddons.clear();
            addonQuantities = {};
            currentSlotMode = '';
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('alldayWarning').classList.add('hidden');
            document.getElementById('btnAllDay').classList.remove('disabled');
        }

        function confirmPlan(planId) {
            resetUI(); 
            currentPlan = PLANS_DB[planId];
            document.getElementById('selectedPlanDisplay').innerText = currentPlan.name;
            document.getElementById('subPlanModal').classList.add('hidden');
            document.getElementById('bookingModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            if (currentPlan.id === 'rental' || currentPlan.id === 'meeting') {
                document.getElementById('btnAllDay').classList.remove('hidden');
            } else {
                document.getElementById('btnAllDay').classList.add('hidden');
            }
            
            const today = new Date();
            let leadDays = 14; 
            if (currentPlan.id === 'rental') leadDays = 1;
            else if (currentPlan.id === 'meeting') leadDays = 3;
            else if (currentPlan.id.startsWith('wedding')) leadDays = 30;

            const minDate = new Date(today);
            minDate.setDate(today.getDate() + leadDays);
            document.getElementById("dateInput").min = minDate.toISOString().split('T')[0];
        }

        function closeModal() { document.getElementById('bookingModal').classList.add('hidden'); document.body.style.overflow = 'auto'; }
        function closeSubModal() { document.getElementById('subPlanModal').classList.add('hidden'); }
        
        // New Menu Logic: Update from Checkbox
        let currentMenuType = ''; // 'food', 'drink_700', 'drink_1200'

        function openMenuModal(type) { 
            currentMenuType = type;
            const menuData = MENUS[type === 'food_platter_1200' ? 'food' : type];
            if(!menuData) return;

            document.getElementById('menuModal').classList.remove('hidden'); 
            document.getElementById('menuModalTitle').innerText = menuData.title;
            const inst = document.getElementById('menuInstruction');
            inst.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${menuData.note}`;
            inst.classList.remove('hidden');

            const form = document.getElementById('dynamicMenuForm');
            form.innerHTML = '';

            menuData.items.forEach((cat, idx) => {
                const catDiv = document.createElement('div');
                catDiv.className = 'menu-category';
                catDiv.innerText = cat.category;
                form.appendChild(catDiv);

                cat.list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'menu-checkbox-item';
                    const id = `menu_${type}_${item}`;
                    
                    // Check if already selected
                    const isChecked = bookingData[`menu_${type}`] && bookingData[`menu_${type}`].includes(item);

                    div.innerHTML = `<input type="checkbox" id="${id}" value="${item}" onchange="updateFromCheckbox(this, '${type}')" ${isChecked?'checked':''}><label for="${id}">${item}</label>`;
                    form.appendChild(div);
                });
            });
        }
        function closeMenuModal() { document.getElementById('menuModal').classList.add('hidden'); }

        // IMPORTANT: Checkbox updates the main counter
        function updateFromCheckbox(checkbox, addonId) {
            const allChecked = document.querySelectorAll(`#dynamicMenuForm input:checked`);
            const count = allChecked.length;
            
            // Save selected items for later message
            if (!bookingData[`menu_${addonId}`]) bookingData[`menu_${addonId}`] = [];
            
            if(checkbox.checked) {
                bookingData[`menu_${addonId}`].push(checkbox.value);
            } else {
                const idx = bookingData[`menu_${addonId}`].indexOf(checkbox.value);
                if(idx > -1) bookingData[`menu_${addonId}`].splice(idx, 1);
            }

            // Sync with main counter
            addonQuantities[addonId] = count;
            renderAddons();
        }

        function handleDateSelect() {
            document.getElementById('dateInput').blur(); 
            checkLogic();
            document.getElementById('timeSelectionArea').scrollIntoView({ behavior: 'smooth' });
        }

        function selectSlot(mode) {
            currentSlotMode = mode;
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
            
            if (mode === 'allday' && currentPlan.id === 'rental') {
                const dateVal = document.getElementById('dateInput').value;
                if(dateVal) {
                    const d = new Date(dateVal);
                    if(d.getDay() === 5) {
                        alert("週五不開放純場地全日租借");
                        return;
                    }
                }
            }

            if(mode === 'lunch') document.getElementById('btnLunch').classList.add('active');
            if(mode === 'dinner') document.getElementById('btnDinner').classList.add('active');
            if(mode === 'allday') document.getElementById('btnAllDay').classList.add('active');
            checkLogic();
        }

        function customTimeTrigger() {
            currentSlotMode = 'custom';
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
            updateEndTime();
        }

        function checkLogic() {
            const dateVal = document.getElementById('dateInput').value;
            document.getElementById('alldayWarning').classList.add('hidden');
            document.getElementById('btnAllDay').classList.remove('disabled');

            if(!dateVal) return;
            const d = new Date(dateVal);
            const day = d.getDay();
            
            if (day === 5 && currentPlan.id === 'rental') {
                 document.getElementById('alldayWarning').classList.remove('hidden');
                 if(currentSlotMode === 'allday') {
                     currentSlotMode = '';
                     document.getElementById('btnAllDay').classList.remove('active');
                 }
                 document.getElementById('btnAllDay').classList.add('disabled');
            }

            isWeekend = (day === 6 || day === 0);
            if (day === 5) {
                if (currentSlotMode === 'dinner') isWeekend = true;
                const startVal = document.getElementById('startTime').value;
                if(currentSlotMode === 'custom' && startVal && parseInt(startVal.split(':')[0]) >= 16) isWeekend = true;
                if (currentSlotMode === 'allday') isWeekend = true;
            }
            document.getElementById('dayTypeLabel').innerText = `${isWeekend?"假日":"平日"}計價`;
        }

        function handleCheck(e) {
            e.preventDefault();
            const dateVal = document.getElementById('dateInput').value;
            if(!dateVal || !currentSlotMode) { alert("請選擇日期與時段"); return; }
            
            checkLogic();
            let basePrice = isWeekend ? currentPlan.priceWeekend : currentPlan.priceWeekday;
            
            if(currentSlotMode === 'allday') {
                if(currentPlan.id === 'rental') {
                    const alldayPlan = PLANS_DB['rental_allday'];
                    if (alldayPlan) basePrice = isWeekend ? alldayPlan.priceWeekend : alldayPlan.priceWeekday;
                    else basePrice = basePrice * 3; 
                } else {
                    basePrice = basePrice * 2; 
                }
            }
            
            document.getElementById('basePriceDisplay').innerText = basePrice.toLocaleString();
            renderIncludedFeatures();
            renderAddons();
            document.getElementById('step2').classList.remove('hidden');
            setTimeout(() => { document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
        }

        function renderIncludedFeatures() {
            const list = document.getElementById('includedFeatures');
            list.innerHTML = '';
            const chairs = CONFIG_DB.global_chairs || 25;
            list.innerHTML += `<li class="text-white font-bold">通用：竹節椅 ${chairs}張、200吋投影、音響麥克風</li>`;
            if(currentPlan.includes && currentPlan.includes.length > 0) {
                currentPlan.includes.forEach(incId => {
                    const item = ADDONS_DB.find(a => a.id === incId);
                    if(item) list.innerHTML += `<li class="text-neon-pink">${item.name}</li>`;
                });
            }
        }

        function renderAddons() {
            const container = document.getElementById('addonList');
            container.innerHTML = '';
            
            // Calculate how many of each addon is INCLUDED
            let includedCounts = {};
            if(currentPlan.includes) {
                currentPlan.includes.forEach(id => {
                    includedCounts[id] = (includedCounts[id] || 0) + 1;
                });
            }

            const isDecorActive = (includedCounts['decor_theme'] || selectedAddons.has('decor_theme') || includedCounts['decor_wedding'] || selectedAddons.has('decor_wedding'));

            ADDONS_DB.forEach(addon => {
                if(currentPlan.id === 'rental') {
                    const allowed = ['extra_hour', 'extra_chair', 'extra_table'];
                    if (!allowed.includes(addon.id)) return;
                }

                let incQty = includedCounts[addon.id] || 0;
                let includedText = incQty > 0 ? `(已內含: ${incQty})` : `(已內含: 0)`;
                
                // Special display logic
                if (addon.id === 'extra_hour') {
                    const baseHrs = (currentPlan.id === 'baby' || currentPlan.id === 'gender') ? 2 : 3;
                    includedText = `(已內含: ${baseHrs}小時)`;
                }
                if (addon.id === 'extra_chair') includedText = `(已內含: 25張)`;

                // Logic Tags
                if(addon.logicTag) {
                    if (addon.id === 'prop_zhuazhou' && currentPlan.id !== 'baby') return;
                    if (addon.id === 'balloon_gender' && currentPlan.id !== 'gender') return;
                    if (addon.id === 'light_marryme' && currentPlan.id !== 'proposal') return;
                    if (addon.id === 'light_birthday' && currentPlan.id !== 'party') return;

                    if(addon.logicTag.startsWith('conflict:')) {
                        const conflictId = addon.logicTag.split(':')[1];
                        if(includedCounts[conflictId]) return; // Hide if plan includes conflict item
                    }
                    if(addon.logicTag.startsWith('require:')) {
                        const reqId = addon.logicTag.split(':')[1];
                        if (reqId === 'meeting' && currentPlan.id !== 'meeting') return;
                    }
                }

                if(addon.type === 'toggle' && includedCounts[addon.id]) return;

                const price = isWeekend ? addon.priceWeekend : addon.priceWeekday;
                const div = document.createElement('div');
                let priceText = `$${price}`;
                if(addon.id === 'decor_wedding') priceText = `$${price} (起)`;

                if(addon.type === 'counter') {
                    const qty = addonQuantities[addon.id] || 0;
                    const activeClass = qty > 0 ? 'border-neon-blue bg-zinc-800' : 'border-zinc-600';
                    
                    let extraHtml = '';
                    if (addon.id === 'food_platter_1200') extraHtml = `<button onclick="openMenuModal('food_platter_1200')" class="text-xs text-neon-blue underline ml-2"><i class="fas fa-utensils"></i> 選擇口味</button>`;
                    if (addon.id === 'drink_700') extraHtml = `<button onclick="openMenuModal('drink_700')" class="text-xs text-champagne underline ml-2"><i class="fas fa-wine-glass"></i> 選擇飲品</button>`;
                    if (addon.id === 'drink_1200') extraHtml = `<button onclick="openMenuModal('drink_1200')" class="text-xs text-champagne underline ml-2"><i class="fas fa-wine-glass"></i> 選擇飲品</button>`;

                    div.className = `addon-btn bg-black border ${activeClass} rounded-lg p-3 flex justify-between items-center transition select-none`;
                    div.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-white flex items-center">${addon.name} ${extraHtml}</span>
                            <div class="flex items-center gap-2 text-xs">
                                <span class="text-gray-500">${priceText}/${addon.unit}</span>
                                <span class="text-neon-pink">${includedText}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="counter-btn" onclick="updateCounter('${addon.id}', -1, ${addon.min}, ${addon.max})"><i class="fas fa-minus text-white text-xs"></i></div>
                            <span class="text-white font-bold w-6 text-center">${qty}</span>
                            <div class="counter-btn" onclick="updateCounter('${addon.id}', 1, ${addon.min}, ${addon.max})"><i class="fas fa-plus text-white text-xs"></i></div>
                        </div>
                    `;
                } else {
                    const isSel = selectedAddons.has(addon.id);
                    const activeClass = isSel ? 'border-neon-blue bg-zinc-800' : 'border-zinc-600 hover:bg-zinc-800';
                    const iconClass = isSel ? 'opacity-100 bg-neon-blue text-black border-neon-blue' : 'opacity-30 border-zinc-500';
                    
                    let subtitle = "";
                    if(addon.id === 'cleaning') subtitle = `<div class="text-[10px] text-gray-500 mt-1">若自行清潔復原，可省下此費用</div>`;

                    div.className = `addon-btn bg-black border ${activeClass} rounded-lg p-3 flex justify-between items-center cursor-pointer transition select-none`;
                    div.onclick = () => toggleAddon(addon);
                    div.innerHTML = `
                        <div class="flex items-center">
                            <div class="check-icon w-5 h-5 rounded-full border ${iconClass} mr-3 flex items-center justify-center transition-all"><i class="fas fa-check text-[10px]"></i></div>
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-white">${addon.name}</span>
                                <span class="text-xs text-neon-pink">${includedText}</span>
                                ${subtitle}
                            </div>
                        </div>
                        <span class="${isSel ? 'text-neon-pink' : 'text-gray-400'} text-sm font-bold">${priceText}</span>
                    `;
                }
                container.appendChild(div);
            });
        }

        function updateCounter(id, delta, min, max) {
            let current = addonQuantities[id] || 0;
            if (id === 'box_meeting' && current === 0 && delta > 0) {
                 let next = min;
                 addonQuantities[id] = next;
                 renderAddons();
                 return;
            }
            let next = current + delta;
            if (id === 'box_meeting' && next < min) { next = 0; } 
            else if (min > 0) {
                if(current === 0 && delta > 0) next = min;
                else if(current === min && delta < 0) next = 0;
                else if(next < min && next > 0) next = min;
            }
            if(next < 0) next = 0;
            if(next > max) { alert(`此項目上限為 ${max}`); next = max; }
            addonQuantities[id] = next;
            
            // Only auto open if it's the FIRST click (from 0 to 1)
            if ((id === 'food_platter_1200' || id === 'drink_700' || id === 'drink_1200') && current === 0 && next > 0 && delta > 0) {
                 openMenuModal(id);
            }
            renderAddons();
        }

        function toggleAddon(addon) {
            const id = addon.id;
            if(addon.logicTag && addon.logicTag.startsWith('mutex:')) {
                const groupName = addon.logicTag.split(':')[1];
                if(selectedAddons.has(id)) {
                    selectedAddons.delete(id);
                } else {
                    ADDONS_DB.forEach(a => {
                        if(a.logicTag === `mutex:${groupName}` && selectedAddons.has(a.id)) {
                            selectedAddons.delete(a.id);
                        }
                    });
                    selectedAddons.add(id);
                }
            } else {
                if(selectedAddons.has(id)) selectedAddons.delete(id);
                else selectedAddons.add(id);
            }
            renderAddons(); 
        }

        function expandFinal() {
            let basePrice = isWeekend ? currentPlan.priceWeekend : currentPlan.priceWeekday;
            if(currentSlotMode === 'allday') {
                if(currentPlan.id === 'rental') {
                    const alldayPlan = PLANS_DB['rental_allday'];
                    if (alldayPlan) basePrice = isWeekend ? alldayPlan.priceWeekend : alldayPlan.priceWeekday;
                    else basePrice = basePrice * 3;
                } else {
                    basePrice = basePrice * 2;
                }
            }
            let addonTotal = 0;
            const invAddons = document.getElementById('invAddons');
            invAddons.innerHTML = '';

            // Calculate included quantities again for deduction
            let includedCounts = {};
            if(currentPlan.includes) {
                currentPlan.includes.forEach(id => { includedCounts[id] = (includedCounts[id] || 0) + 1; });
            }

            for (const [id, qty] of Object.entries(addonQuantities)) {
                if (qty > 0) {
                    const item = ADDONS_DB.find(a => a.id === id);
                    if(item) {
                        const price = isWeekend ? item.priceWeekend : item.priceWeekday;
                        
                        // == [NEW] Deduct included quantity ==
                        let includedQty = includedCounts[id] || 0;
                        let chargeableQty = Math.max(0, qty - includedQty);
                        const sub = chargeableQty * price;
                        
                        addonTotal += sub;
                        
                        let note = "";
                        if (bookingData[`menu_${id}`] && bookingData[`menu_${id}`].length > 0) {
                            note = `<br><span class="text-xs text-gray-400">口味: ${bookingData[`menu_${id}`].join(', ')}</span>`;
                        }

                        let priceDisplay = `$${sub.toLocaleString()}`;
                        if (chargeableQty < qty) priceDisplay += ` <span class="text-[10px] text-green-400">(扣抵${includedQty}個)</span>`;

                        invAddons.innerHTML += `<li class="flex flex-col border-b border-gray-200 pb-1"><div class="flex justify-between"><span>${item.name} x ${qty}</span><span>${priceDisplay}</span></div>${note}</li>`;
                    }
                }
            }

            selectedAddons.forEach(id => {
                const item = ADDONS_DB.find(a => a.id === id);
                if(item) {
                    const price = isWeekend ? item.priceWeekend : item.priceWeekday;
                    addonTotal += price;
                    invAddons.innerHTML += `<li class="flex justify-between border-b border-gray-200 pb-1"><span>${item.name}</span><span>$${price.toLocaleString()}</span></li>`;
                }
            });

            if(invAddons.innerHTML === '') invAddons.innerHTML = '<li class="text-gray-400 italic">無加購項目</li>';
            const total = basePrice + addonTotal;
            document.getElementById('invPlanName').innerText = currentPlan.name;
            document.getElementById('invPlanPrice').innerText = `$${basePrice.toLocaleString()}`;
            document.getElementById('invDate').innerText = `${document.getElementById('dateInput').value} ${isWeekend?"(假日)":"(平日)"}`;
            let timeStr = "";
            if(currentSlotMode === 'lunch') timeStr = "11:00-14:00";
            else if(currentSlotMode === 'dinner') timeStr = "17:00-20:00";
            else if(currentSlotMode === 'allday') timeStr = "09:00-21:00";
            else {
                const start = document.getElementById('startTime').value;
                const end = document.getElementById('endTimeDisplay').value.split(' ')[0];
                timeStr = `${start}-${end}`;
            }
            document.getElementById('invTimeRange').innerText = timeStr;
            document.getElementById('invTotal').innerText = `NT$ ${total.toLocaleString()}`;
            bookingData.finalDetails = invAddons.innerHTML; // save for LINE
            bookingData.finalTotal = total;
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('step3').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ==========================================
        // 【關鍵修正區】: 修正傳送給 GAS 的資料欄位名稱
        // ==========================================
        function sendFinalToLine() {
            const name = document.getElementById('guestName').value;
            const phone = document.getElementById('guestPhone').value;
            
            if(!name || !phone) { 
                alert("請填寫姓名與電話，以便我們進行登記！"); 
                if(!name) document.getElementById('guestName').focus();
                else document.getElementById('guestPhone').focus();
                return; 
            }

            const submitBtn = document.querySelector('button[onclick="sendFinalToLine()"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> 資料登記中...';
            submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

            // 修正點：這裡的 key 改成對應 GAS 腳本的 planName 和 totalPrice
            const sheetData = {
                type: 'BOOKING',                // 讓 GAS 知道這是預約請求
                name: name,
                phone: phone,
                planName: currentPlan.name,     // 原本是 plan，改成 planName (或 GAS 裡也要對應)
                totalPrice: bookingData.finalTotal, // 原本是 total，改成 totalPrice (避免 0)
                date: document.getElementById('invDate').innerText,
                time: document.getElementById('invTimeRange').innerText,
                note: "" // 如果有備註欄位可以加，目前留空
            };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(sheetData),
                headers: { "Content-Type": "text/plain" }
            })
            .then(response => {
                console.log("Sheet update success");
                proceedToLine(name, phone);
            })
            .catch(error => {
                console.error("Sheet update error:", error);
                proceedToLine(name, phone);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            });
        }

        function proceedToLine(name, phone) {
            let detailsText = "";
            
            // Re-calc for text
            let includedCounts = {};
            if(currentPlan.includes) {
                currentPlan.includes.forEach(id => { includedCounts[id] = (includedCounts[id] || 0) + 1; });
            }

            for (const [id, qty] of Object.entries(addonQuantities)) {
                if (qty > 0) {
                    const item = ADDONS_DB.find(a => a.id === id);
                    if(item) {
                        let includedQty = includedCounts[id] || 0;
                        detailsText += `- ${item.name} x ${qty} ${item.unit} (內含:${includedQty})\n`;
                        if (bookingData[`menu_${id}`]) {
                            detailsText += `   口味: ${bookingData[`menu_${id}`].join(', ')}\n`;
                        }
                    }
                }
            }
            selectedAddons.forEach(id => {
                const item = ADDONS_DB.find(a => a.id === id);
                if(item) detailsText += `- ${item.name}\n`;
            });
            if(detailsText === "") detailsText = "無\n";
            
            let includesText = "";
            if(currentPlan.includes && currentPlan.includes.length > 0) {
                const uniqueIncludes = [...new Set(currentPlan.includes)];
                uniqueIncludes.forEach(incId => {
                    const item = ADDONS_DB.find(a => a.id === incId);
                    if(item) includesText += `- ${item.name} (內含)\n`;
                });
            }

            let msg = `您好！我想預約 RUINS BAR 🥂\n\n👤 姓名：${name}\n📱 電話：${phone}\n------------------------\n📅 日期：${document.getElementById('invDate').innerText}\n⏰ 時段：${document.getElementById('invTimeRange').innerText}\n📋 方案：${currentPlan.name}\n\n✅ 方案基本內含：\n${includesText}\n➕ 加購/升級內容：\n${detailsText}\n💰 預估總價：NT$ ${bookingData.finalTotal.toLocaleString()}\n\n請協助確認檔期，謝謝！`;

            copyToClipboard(msg).then(() => {
                document.getElementById('copySuccessModal').classList.remove('hidden');
                closeModal();
            });
        }

        function initCustomTimeSelects() {
            const s = document.getElementById('startTime');
            for (let i = 18; i <= 42; i++) { 
                const hour = Math.floor(i / 2);
                const min = (i % 2) === 0 ? '00' : '30';
                const t = `${hour < 10 ? '0'+hour : hour}:${min}`;
                s.add(new Option(t, t));
            }
        }
        function updateEndTime() {
            const startVal = document.getElementById('startTime').value;
            if(!startVal) return;
            const [h, m] = startVal.split(':').map(Number);
            let endH = h + 3;
            let suffix = "";
            if(endH >= 24) { endH -= 24; suffix = "(+1)"; }
            const t = `${endH < 10 ? '0'+endH : endH}:${m===0?'00':m}${suffix}`;
            document.getElementById('endTimeDisplay').value = t + " (3hr)";
        }
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
            else {
                let textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try { document.execCommand('copy'); } catch (err) {}
                document.body.removeChild(textArea);
                return Promise.resolve();
            }
        }
        function goToLine() { window.location.href = LINE_DEEP_LINK; }
        function closeCopyModal() { document.getElementById('copySuccessModal').classList.add('hidden'); }
    </script>
</body>
</html>
