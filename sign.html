<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å ´åœ°ç§Ÿè³ƒåˆç´„ç°½ç½² | å»¢å¢Ÿ BAR</title>
    <meta name="robots" content="noindex, nofollow"> 

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh_tw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        :root { --c-dark: #1a1a1a; --c-gold: #c5a47e; --c-gold-light: #f4f1ea; --c-red: #A94442; --c-gray: #7F8C8D; --c-white: #FFFFFF; --font-serif: 'Noto Serif TC', serif; --font-sans: 'Noto Sans TC', sans-serif; --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08); }
        *, *::before, *::after { box-sizing: border-box; }
        
        body { margin: 0; font-family: var(--font-sans); background-color: #eee; color: var(--c-dark); line-height: 1.7; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; overscroll-behavior: none; }

        .navbar { background: var(--c-dark); height: 60px; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; width: 100%; z-index: 999; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-logo { color: var(--c-gold); font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; letter-spacing: 2px; text-decoration: none; }

        .header-section { margin-top: 60px; padding: 40px 20px; text-align: center; background: #222; color: white; background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80'); background-size: cover; background-position: center; }
        .header-section h1 { margin: 0; font-family: var(--font-serif); font-size: 1.8rem; letter-spacing: 3px; font-weight: 500; }
        .header-section p { margin: 5px 0 0; font-size: 0.8rem; color: var(--c-gold); text-transform: uppercase; letter-spacing: 2px; }

        .container { width: 95%; max-width: 800px; margin: -30px auto 40px; position: relative; z-index: 10; }

        #capture-area { background-color: var(--c-white); padding: 50px; border-radius: 4px; box-shadow: var(--shadow-card); border-top: 6px solid var(--c-gold); position: relative; }
        #capture-area::before { content: "RUINS BAR"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 5rem; font-weight: bold; color: rgba(0,0,0,0.03); pointer-events: none; white-space: nowrap; font-family: sans-serif; }

        .contract-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #EEE; padding-bottom: 20px; }
        .contract-header h2 { margin: 0; font-family: var(--font-serif); color: var(--c-dark); font-size: 1.6rem; letter-spacing: 1px; }
        .contract-header span { display: block; margin-top: 5px; color: var(--c-gray); font-size: 0.8rem; letter-spacing: 1px; }

        /* Form Grid System */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 5px; }
        .col-full { grid-column: 1 / -1; } 
        .col-third { grid-template-columns: 1fr 1fr 1fr; }

        .form-label { display: block; font-size: 0.8rem; color: var(--c-gray); margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input { width: 100%; padding: 10px; font-size: 0.95rem; color: var(--c-dark); font-family: var(--font-serif); border: 1px solid #DDD; border-radius: 4px; background: #FAFAFA; transition: 0.3s; }
        .form-input:focus { outline: none; border-color: var(--c-gold); background: #FFF; box-shadow: 0 0 0 3px rgba(197, 164, 126, 0.1); }
        .form-input.readonly { background: #F9F5EB; border-color: #E0D6C3; color: #8A7A5B; font-weight: bold; cursor: default; }

        .inline-input { border: none; border-bottom: 1px solid #888; background: transparent; padding: 0 5px; font-family: var(--font-serif); font-weight: bold; color: var(--c-dark); text-align: center; width: 80px; }
        .inline-input:focus { outline: none; border-bottom: 2px solid var(--c-gold); }

        .section-title { font-family: var(--font-serif); font-size: 1.1rem; color: var(--c-dark); margin: 30px 0 15px; padding-left: 10px; border-left: 4px solid var(--c-gold); font-weight: bold; }
        
        .legal-text { font-size: 0.9rem; color: #444; text-align: justify; line-height: 1.8; }
        .legal-text p { margin-bottom: 10px; }
        .legal-text ul { padding-left: 20px; margin: 5px 0 15px; }
        .legal-text li { margin-bottom: 5px; }
        
        .highlight { color: var(--c-red); font-weight: bold; background: #FDEDEC; padding: 0 4px; border-radius: 2px;}
        .money-val { font-family: monospace; font-weight: bold; color: var(--c-dark); }

        /* ç°½åå€ */
        .signature-section { margin-top: 50px; page-break-inside: avoid; }
        .sign-area-box { border: 2px dashed #BDC3C7; background: #FAFAFA; border-radius: 8px; position: relative; height: 180px; margin-top: 10px; cursor: crosshair; overflow: hidden; touch-action: none; }
        .sign-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #BDC3C7; font-size: 1.5rem; font-family: var(--font-serif); pointer-events: none; opacity: 0.5; }
        .sign-placeholder::after { content: "( è«‹åœ¨æ­¤è™•ç°½å )"; display: block; font-size: 0.8rem; text-align: center; margin-top: 5px; font-family: var(--font-sans); }
        canvas { display: block; width: 100%; height: 100%; }
        
        .sign-tools { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .date-display { font-family: monospace; color: var(--c-dark); font-weight: bold; }
        .btn-clear { background: none; border: none; color: var(--c-gray); cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .btn-clear:hover { color: var(--c-red); }

        .action-area { text-align: center; margin-top: 40px; }
        .btn-submit { background-color: var(--c-dark); color: var(--c-gold); border: 1px solid var(--c-dark); padding: 18px 60px; font-size: 1.1rem; font-weight: bold; letter-spacing: 1px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.2); display: inline-flex; align-items: center; gap: 10px; }
        .btn-submit:hover { background-color: var(--c-gold); color: white; border-color: var(--c-gold); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(197, 164, 126, 0.3); }
        .btn-submit:disabled { background-color: #BDC3C7; border-color: #BDC3C7; color: white; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .footer { text-align: center; color: #999; font-size: 0.8rem; padding: 40px 0; margin-top: auto; }
        .highlight-error { animation: shake 0.5s; border-color: var(--c-red) !important; background-color: #FDEDEC !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        div:where(.swal2-container) h2:where(.swal2-title) { font-family: var(--font-serif) !important; color: var(--c-dark) !important; }
        div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm { background-color: var(--c-gold) !important; box-shadow: 0 4px 15px rgba(197, 164, 126, 0.4) !important; }

        @media (max-width: 768px) {
            #capture-area { padding: 30px 20px; }
            .form-grid { grid-template-columns: 1fr; gap: 15px; }
            .header-section h1 { font-size: 1.5rem; }
            .time-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        }
    </style>
</head>
<body>

    <nav class="navbar"><a href="#" class="nav-logo">å»¢å¢Ÿ BAR | RUINS</a></nav>
    <div class="header-section"><h1>å ´åœ°ç§Ÿè³ƒåˆç´„</h1><p>Venue Rental Agreement</p></div>

    <div class="container">
        <div id="capture-area">
            <div class="contract-header"><h2>å ´åœ°ç§Ÿè³ƒåˆç´„æ›¸</h2><span>å‡ºç§Ÿæ–¹ï¼šå»¢å¢Ÿ BAR (ç”²æ–¹)</span></div>

            <div class="form-grid">
                <div class="form-group col-full">
                    <label class="form-label">æ‰¿ç§Ÿæ–¹ / ä¹™æ–¹ (Tenant Name / Company)</label>
                    <input type="text" id="booker-name" class="form-input" placeholder="è«‹è¼¸å…¥å€‹äººæˆ–å…¬å¸åç¨±">
                </div>
                <div class="form-group">
                    <label class="form-label">è¯çµ¡é›»è©± (Phone)</label>
                    <input type="tel" id="booker-phone" class="form-input" placeholder="09xxxxxxxx">
                </div>
                <div class="form-group">
                    <label class="form-label">æ´»å‹•ä¸»è¦å…§å®¹ (Activity)</label>
                    <input type="text" id="activity-content" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ´¾å°ã€æ‹æ”ã€è¬›åº§...">
                </div>
            </div>

            <div class="legal-text">
                <p>ç«‹åˆç´„æ›¸äºº å‡ºç§Ÿæ–¹ï¼ˆä»¥ä¸‹ç°¡ç¨±ç”²æ–¹ï¼‰ï¼š<strong>å»¢å¢Ÿ BAR</strong> èˆ‡ æ‰¿ç§Ÿæ–¹ï¼ˆä»¥ä¸‹ç°¡ç¨±ä¹™æ–¹ï¼‰ï¼Œé›™æ–¹å°±å ´åœ°ç§Ÿè³ƒäº‹å®œï¼Œç¶“å”è­°è¨‚ç«‹æ¢æ¬¾å¦‚ä¸‹ï¼Œä»¥èŒ²éµå®ˆï¼š</p>

                <div class="section-title">ç¬¬ä¸€æ¢ï¼šç§Ÿè³ƒæ¨™çš„èˆ‡ç”¨é€”</div>
                <p>
                    1. å ´åœ°åç¨±ï¼š<strong>å»¢å¢Ÿ BAR</strong><br>
                    2. å ´åœ°åœ°é»ï¼šé«˜é›„å¸‚é¹½åŸ•å€ç€¨å—è¡—205è™Ÿ<br>
                    3. ä½¿ç”¨ç”¨é€”ï¼šä¹™æ–¹ç§Ÿç”¨å ´åœ°ä¸»è¦ç”¨æ–¼ä¸Šè¿°å¡«å¯«ä¹‹æ´»å‹•å…§å®¹ï¼Œæœªç¶“ç”²æ–¹åŒæ„ï¼Œä¸å¾—æ“…è‡ªè®Šæ›´ç”¨é€”æˆ–è½‰ç§Ÿä»–äººã€‚
                </p>

                <div class="section-title">ç¬¬äºŒæ¢ï¼šç§Ÿè³ƒæœŸé–“ (Rental Period)</div>
                <div class="form-grid" style="margin-bottom: 10px;">
                    <div class="form-group col-full">
                        <label class="form-label">ä½¿ç”¨æ—¥æœŸ (Date)</label>
                        <input type="text" id="date-picker" class="form-input readonly" placeholder="è«‹é¸æ“‡ä½¿ç”¨æ—¥æœŸ" readonly>
                    </div>
                    <div class="form-group col-full time-group">
                        <div>
                            <label class="form-label">é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="time-start" class="form-input" value="13:00">
                        </div>
                        <div>
                            <label class="form-label">çµæŸæ™‚é–“</label>
                            <input type="time" id="time-end" class="form-input" value="17:00">
                        </div>
                    </div>
                </div>
                <p style="font-size:0.85rem; color:#666;">
                    * ä¸Šè¿°æ™‚é–“åŒ…å«é€²å ´ä½ˆç½®ã€æ´»å‹•é€²è¡ŒåŠæ’¤å ´æ¸…æ½”æ™‚é–“ã€‚<br>
                    * <span class="highlight">è¶…æ™‚è²»ç”¨</span>ï¼šè‹¥æœªæ–¼ç´„å®šæ™‚é–“å…§å®Œæˆæ’¤å ´ï¼Œè¶…æ™‚æœªæ»¿30åˆ†é˜ä»¥30åˆ†é˜è¨ˆç®—ï¼Œæ¯30åˆ†é˜åŠ æ”¶ NT$ 1,500 å…ƒï¼›è‹¥å½±éŸ¿ä¸‹ä¸€çµ„å®¢äººæ¬Šç›Šï¼Œç”²æ–¹å¾—è«‹æ±‚æå®³è³ å„Ÿã€‚
                </p>

                <div class="section-title">ç¬¬ä¸‰æ¢ï¼šè²»ç”¨èˆ‡ä»˜æ¬¾æ–¹å¼ (Fees)</div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                    <div class="form-group">
                        <label class="form-label">å ´åœ°ç§Ÿé‡‘ç¸½é¡</label>
                        <input type="number" id="fee-rent" class="form-input" placeholder="è¼¸å…¥é‡‘é¡">
                    </div>
                    <div class="form-group">
                        <label class="form-label">é ç´„è¨‚é‡‘ (30%)</label>
                        <input type="number" id="fee-deposit" class="form-input" value="5000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å±¥ç´„ä¿è­‰é‡‘</label>
                        <input type="number" id="fee-bond" class="form-input" value="3000">
                    </div>
                </div>
                <ul style="font-size:0.9rem;">
                    <li><strong>è¨‚é‡‘æ”¯ä»˜ï¼š</strong>ä¹™æ–¹ç°½ç´„æ™‚æ‡‰æ”¯ä»˜è¨‚é‡‘ä»¥ä¿ç•™æª”æœŸã€‚</li>
                    <li><strong>å°¾æ¬¾æ”¯ä»˜ï¼š</strong>é¤˜æ¬¾æ‡‰æ–¼æ´»å‹•ç•¶æ—¥å…¥å ´å‰ä»˜æ¸…ã€‚</li>
                    <li><strong>ä¿è­‰é‡‘é€€é‚„ï¼š</strong>æ´»å‹•çµæŸå¾Œï¼Œç¶“ç”²æ–¹æª¢æŸ¥å ´åœ°è¨­å‚™ç„¡æå£ã€åƒåœ¾å·²ä¾è¦å®šè™•ç†ï¼Œä¿è­‰é‡‘å°‡å…¨é¡ç„¡æ¯é€€é‚„ã€‚</li>
                </ul>

                <div class="section-title">ç¬¬å››æ¢ï¼šå–æ¶ˆèˆ‡è®Šæ›´æ”¿ç­–</div>
                <ul>
                    <li>æ´»å‹•æ—¥ 14 å¤©å‰é€šçŸ¥ï¼šé€€é‚„å·²ä»˜è¨‚é‡‘ 100%ã€‚</li>
                    <li>æ´»å‹•æ—¥ 7 è‡³ 13 å¤©å‰é€šçŸ¥ï¼šé€€é‚„å·²ä»˜è¨‚é‡‘ 50%ã€‚</li>
                    <li>æ´»å‹•æ—¥ 3 è‡³ 6 å¤©å‰é€šçŸ¥ï¼šé€€é‚„å·²ä»˜è¨‚é‡‘ 30%ã€‚</li>
                    <li><span class="highlight">æ´»å‹•æ—¥ 3 å¤©å…§ï¼ˆå«ç•¶æ—¥ï¼‰å–æ¶ˆ</span>ï¼šè¨‚é‡‘å…¨é¡æ²’æ”¶ï¼Œä¸äºˆé€€é‚„ã€‚</li>
                    <li>å¦‚é‡å¤©ç½ï¼ˆå¦‚é¢±é¢¨é«˜é›„å¸‚æ”¿åºœå®£å¸ƒåœç­åœèª²ï¼‰ç­‰ä¸å¯æŠ—åŠ›å› ç´ ï¼Œé›™æ–¹å¯å”è­°å»¶æœŸæˆ–å…¨é¡é€€è²»ã€‚</li>
                </ul>

                <div class="section-title">ç¬¬äº”æ¢ï¼šå ´åœ°ä½¿ç”¨è¦ç¯„ (é‡è¦)</div>
                <p>ç‚ºç¶­è­·å ´åœ°å“è³ªåŠå‘¨é‚Šå®‰å¯§ï¼Œä¹™æ–¹åŒæ„éµå®ˆä»¥ä¸‹è¦ç¯„ï¼š</p>
                <ul>
                    <li><strong>ä½ˆç½®è¦ç¯„ï¼š</strong>åš´ç¦ä½¿ç”¨é›™é¢è† ã€é‡˜æ§ç­‰æœƒç ´å£ç‰†é¢ä¹‹é»è‘—åŠ‘ã€‚å»ºè­°ä½¿ç”¨ç„¡ç—•è† å¸¶æˆ–è¼æŸé»åœŸã€‚è‹¥é€ æˆç‰†é¢å‰è½ï¼Œå°‡è‡ªä¿è­‰é‡‘ä¸­æ‰£é™¤ä¿®å¾©è²»ç”¨ï¼ˆæ¯è™•æœ€ä½ NT$ 500 å…ƒèµ·ï¼‰ã€‚</li>
                    <li><strong>é£²é£Ÿèˆ‡æ¸…æ½”ï¼š</strong>åš´ç¦æ–¼æ²™ç™¼æˆ–å¸ƒç¹”å“ä¸Šæ½‘ç‘é›£ä»¥æ¸…æ´—ä¹‹é£²æ–™ï¼ˆå¦‚ç´…é…’ï¼‰ã€‚åƒåœ¾éœ€è‡ªè¡Œåˆ†é¡æ‰“åŒ…ã€‚è‹¥å ´åœ°éåº¦é«’äº‚ï¼ˆå¦‚å˜”åç‰©ã€ç ¸æ´¾ï¼‰ï¼ŒåŠ æ”¶ç‰¹æ®Šæ¸…æ½”è²» NT$ 1,000 ~ 3,000 å…ƒã€‚</li>
                    <li><strong>å®‰å…¨èˆ‡ç¦å¿Œï¼š</strong>å…¨å®¤å…§<span class="highlight">å…¨é¢ç¦æ­¢å¸è¸</span>ï¼ˆå«é›»å­è¸ï¼‰ã€‚åš´ç¦ä½¿ç”¨æ˜ç«ï¼ˆå¦‚è Ÿç‡­ã€ä»™å¥³æ£’ï¼‰ã€æ‹‰ç‚®ã€ç²‰å¡µã€‚åš´ç¦è³­åšã€å¸æ¯’ã€æ€§äº¤æ˜“ã€‚</li>
                    <li><strong>éŸ³é‡æ§åˆ¶ï¼š</strong>æ™šé–“ 22:00 å¾Œè«‹é™ä½éŸ³é‡ã€‚è‹¥å› éŸ³é‡éå¤§é­æª¢èˆ‰ï¼Œç”±ä¹™æ–¹è‡ªè¡Œæ‰¿æ“”è²¬ä»»ã€‚</li>
                </ul>

                <div class="section-title">ç¬¬å…­æ¢ï¼šè¨­å‚™æå®³è³ å„Ÿ</div>
                <p>ä¹™æ–¹æ‡‰æ„›æƒœä½¿ç”¨å ´å…§æ‰€æœ‰è¨­å‚™ã€‚è‹¥å› äººç‚ºå› ç´ å°è‡´è¨­å‚™æå£ã€éºå¤±æˆ–é«’æ±™ï¼Œä¹™æ–¹éœ€ç…§åƒ¹è³ å„Ÿï¼ˆåŒ…å«ç¶­ä¿®è²»ã€é‹è²»åŠç‡Ÿæ¥­æå¤±ï¼‰ã€‚ç”²æ–¹ä¸è² ä¿ç®¡ä¹™æ–¹ç§äººç‰©å“ä¹‹è²¬ä»»ã€‚</p>

                <div class="section-title">ç¬¬ä¸ƒæ¢ï¼šå…¶ä»–</div>
                <p>æœ¬åˆç´„è‹¥æœ‰æœªç›¡äº‹å®œï¼Œä¾ä¸­è¯æ°‘åœ‹æ³•å¾‹è¾¦ç†ã€‚è‹¥ç™¼ç”Ÿè¨´è¨Ÿï¼ŒåŒæ„ä»¥è‡ºç£é«˜é›„åœ°æ–¹æ³•é™¢ç‚ºç¬¬ä¸€å¯©ç®¡è½„æ³•é™¢ã€‚</p>
            </div>

            <div class="signature-section">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:5px;">
                    <div style="font-weight:bold; font-family:var(--font-serif); font-size:1.1rem;">æ‰¿ç§Ÿæ–¹(ä¹™æ–¹) ç°½å</div>
                    <div style="font-size:0.8rem; color:#888;">æœ¬äººå·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°æ‰€æœ‰æ¢æ¬¾</div>
                </div>
                <div class="sign-area-box" id="sign-wrapper">
                    <span class="sign-placeholder">Sign Here</span>
                    <canvas id="signature-canvas"></canvas>
                </div>
                <div class="sign-tools">
                    <div id="date-display" class="date-display"></div>
                    <button class="btn-clear" onclick="clearPad()"><i class="fa-solid fa-eraser"></i> æ¸…é™¤é‡ç°½</button>
                </div>
            </div>
        </div>

        <div class="action-area">
            <button id="btn-submit" class="btn-submit" onclick="submitContract()">
                <span id="btn-text">ç¢ºèªç°½ç½²ä¸¦é€å‡ºåˆç´„</span>
                <i class="fa-solid fa-arrow-right"></i>
            </button>
            <p style="font-size:0.85rem; color:#999; margin-top:15px;"><i class="fa-solid fa-shield-halved"></i> ç³»çµ±å°‡è‡ªå‹•ç”Ÿæˆåˆç´„ PDF ä¸¦åŠ å¯†å­˜æª”</p>
        </div>
    </div>

    <footer class="footer">Â© 2025 å»¢å¢Ÿ BAR (Ruins BAR). All Rights Reserved.</footer>

    <script>
        const GAS_APP_URL = "https://script.google.com/macros/s/AKfycbx-6u0XJ4fnk_EfbXUrwbaJbb69RWkvfHwxoBpznAxM65XC8wQZEwD-I-HvqawP7SyT/exec";
        const MY_LIFF_ID = "2008702134-FRWP0LWx"; 

        const { jsPDF } = window.jspdf;
        let datePicker;

        document.addEventListener('DOMContentLoaded', function() {
            if (typeof liff !== 'undefined') { liff.init({ liffId: MY_LIFF_ID }).catch(err => console.error(err)); }
            // æ”¹ç‚ºå–®æ—¥é¸æ“‡
            datePicker = flatpickr("#date-picker", { 
                mode: "single", 
                minDate: "today", 
                dateFormat: "Y-m-d", 
                locale: "zh_tw" 
            });
            initSignaturePad();
            
            // é¡¯ç¤ºç•¶å‰æ—¥æœŸ
            const now = new Date();
            document.getElementById('date-display').innerText = "ç°½ç½²æ—¥æœŸ: " + now.toLocaleDateString('zh-TW');
        });

        const canvas = document.getElementById('signature-canvas');
        const ctx = canvas.getContext('2d');
        let hasSigned = false;

        function initSignaturePad() {
            const wrapper = document.getElementById('sign-wrapper');
            function resize() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = wrapper.offsetWidth * ratio;
                canvas.height = wrapper.offsetHeight * ratio;
                ctx.scale(ratio, ratio);
                ctx.lineWidth = 3; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
            }
            window.addEventListener('resize', resize);
            resize(); 
            let isDrawing = false;
            
            const start = (e) => { 
                if(e.type === 'touchstart') e.preventDefault();
                isDrawing = true; hasSigned = true; 
                document.querySelector('.sign-placeholder').style.display = 'none'; 
                ctx.beginPath(); draw(e); 
            };
            const end = () => { isDrawing = false; ctx.beginPath(); };
            const draw = (e) => {
                if(!isDrawing) return;
                if(e.type === 'touchmove') e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                let x = (e.clientX || e.touches[0].clientX) - rect.left;
                let y = (e.clientY || e.touches[0].clientY) - rect.top;
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            };
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', end);
        }

        function clearPad() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.querySelector('.sign-placeholder').style.display = 'block';
            hasSigned = false;
        }

        async function submitContract() {
            const name = document.getElementById('booker-name').value.trim();
            const phone = document.getElementById('booker-phone').value.trim();
            const activity = document.getElementById('activity-content').value.trim();
            const dateVal = document.getElementById('date-picker').value;
            const timeStart = document.getElementById('time-start').value;
            const timeEnd = document.getElementById('time-end').value;
            const feeRent = document.getElementById('fee-rent').value;

            const phoneRegex = /^09\d{8}$/;

            // é©—è­‰é‚è¼¯
            if (!name) return alertAndFocus("è«‹è¼¸å…¥æ‰¿ç§Ÿæ–¹å§“å/å…¬å¸", "booker-name");
            if (!phoneRegex.test(phone)) return alertAndFocus("è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼", "booker-phone");
            if (!activity) return alertAndFocus("è«‹è¼¸å…¥æ´»å‹•ä¸»è¦å…§å®¹", "activity-content");
            if (!dateVal) return alertAndFocus("è«‹é¸æ“‡ä½¿ç”¨æ—¥æœŸ", "date-picker");
            if (!feeRent) return alertAndFocus("è«‹å¡«å¯«å ´åœ°ç§Ÿé‡‘é‡‘é¡", "fee-rent");
            if (!hasSigned) return alertAndFocus("è«‹åœ¨ä¸‹æ–¹ç°½åæ¬„ä½ç°½å", "sign-wrapper");

            const btn = document.getElementById('btn-submit');
            const btnText = document.getElementById('btn-text');
            
            btn.disabled = true;
            btnText.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> åˆç´„ç”Ÿæˆä¸­...';

            try {
                // æª”åè¦å‰‡: æ—¥æœŸ_å»¢å¢ŸBAR_å§“å_é›»è©±.pdf
                const cleanDate = dateVal.replace(/-/g, '');
                const fileName = `${cleanDate}_å»¢å¢ŸBAR_${name}.pdf`;

                const captureArea = document.getElementById("capture-area");
                
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const scale = isMobile ? 2 : 3;
                const quality = isMobile ? 0.6 : 0.75;

                const canvasData = await html2canvas(captureArea, { scale: scale, useCORS: true, backgroundColor: "#ffffff", logging: false });
                const imgData = canvasData.toDataURL('image/jpeg', quality);
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                if (imgHeight > pdf.internal.pageSize.getHeight()) {
                    const longPdf = new jsPDF('p', 'mm', [pdfWidth, imgHeight + 10]);
                    longPdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    var pdfBase64 = longPdf.output('datauristring');
                } else {
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                    var pdfBase64 = pdf.output('datauristring');
                }

                btnText.innerHTML = '<i class="fa-solid fa-cloud-arrow-up fa-spin"></i> ä¸Šå‚³ä¸­...';

                // ä¸Šå‚³åˆ° GAS (ä¿æŒåŸé‚è¼¯)
                const response = await fetch(GAS_APP_URL, {
                    method: "POST",
                    redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ type: "UPLOAD_IMG", image: pdfBase64, filename: fileName, user: name })
                });

                const textResponse = await response.text();
                let result;
                try { result = JSON.parse(textResponse); } catch(e) { throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤"); }

                if (result.status === "success") {
                    const downloadLink = result.url;
                    
                    if (liff.isInClient()) {
                        try {
                            const flexMessage = {
                                "type": "flex",
                                "altText": "âœ… å»¢å¢Ÿ BAR å ´åœ°åˆç´„å·²ç°½ç½²å®Œæˆ",
                                "contents": {
                                    "type": "bubble",
                                    "size": "mega",
                                    "header": {
                                        "type": "box", "layout": "vertical", "backgroundColor": "#1a1a1a", "paddingAll": "xl",
                                        "contents": [
                                            { "type": "text", "text": "âœ… ç°½ç´„å®Œæˆç¢ºèª", "color": "#c5a47e", "weight": "bold", "size": "lg", "align": "center" },
                                            { "type": "text", "text": "VENUE RENTAL CONTRACT", "color": "#95A5A6", "size": "xxs", "align": "center", "margin": "xs", "letterSpacing": "1px" }
                                        ]
                                    },
                                    "body": {
                                        "type": "box", "layout": "vertical", "paddingAll": "xl",
                                        "contents": [
                                            { "type": "text", "text": `æ‰¿ç§Ÿäººï¼š${name}`, "weight": "bold", "size": "md", "color": "#1a1a1a" },
                                            { "type": "text", "text": "æ‚¨çš„å ´åœ°ç§Ÿè³ƒåˆç´„å·²å®Œæˆç°½ç½²ã€‚", "size": "sm", "color": "#7F8C8D", "margin": "sm" },
                                            { "type": "separator", "margin": "xl" },
                                            {
                                                "type": "box", "layout": "vertical", "margin": "xl", "spacing": "sm",
                                                "contents": [
                                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ“ åœ°é»", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": "å»¢å¢Ÿ BAR", "wrap": true, "color": "#1a1a1a", "size": "sm", "flex": 5, "weight": "bold" }] },
                                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "ğŸ“… æ—¥æœŸ", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": dateVal, "color": "#1a1a1a", "size": "sm", "flex": 5 }] },
                                                    { "type": "box", "layout": "baseline", "contents": [{ "type": "text", "text": "â° æ™‚æ®µ", "color": "#95A5A6", "size": "sm", "flex": 2 }, { "type": "text", "text": `${timeStart} - ${timeEnd}`, "color": "#1a1a1a", "size": "sm", "flex": 5 }] }
                                                ]
                                            },
                                            { "type": "separator", "margin": "xl" },
                                            { "type": "button", "style": "primary", "height": "sm", "color": "#c5a47e", "margin": "md", "action": { "type": "uri", "label": "ä¸‹è¼‰åˆç´„ PDF", "uri": downloadLink } },
                                            { "type": "text", "text": "âš ï¸ é€£çµ 15 å¤©å…§æœ‰æ•ˆï¼Œè«‹ç›¡é€Ÿä¸‹è¼‰ã€‚", "size": "xxs", "color": "#E74C3C", "margin": "md", "align": "center" }
                                        ]
                                    }
                                }
                            };
                            await liff.sendMessages([flexMessage]);
                        } catch (msgErr) {
                            console.error("Flex failed", msgErr);
                            await liff.sendMessages([{ type: "text", text: `ã€ç°½ç´„å®Œæˆã€‘\næ‰¿ç§Ÿäººï¼š${name}\næ—¥æœŸï¼š${dateVal}\nåˆç´„ä¸‹è¼‰ï¼š${downloadLink}` }]);
                        }
                        await Swal.fire({ icon: 'success', title: 'ç°½ç½²å®Œæˆ', text: 'åˆç´„å·²å‚³é€è‡³ LINE', confirmButtonColor: '#1a1a1a', timer: 3000 });
                        liff.closeWindow();
                        
                    } else {
                        Swal.fire({
                            icon: 'success', title: 'ç°½ç´„æˆåŠŸï¼',
                            html: `<a href="${downloadLink}" target="_blank" style="display:block; background:#c5a47e; color:white; padding:15px; border-radius:50px; text-decoration:none; font-weight:bold; margin-top:20px;">ä¸‹è¼‰åˆç´„ PDF</a>`,
                            showConfirmButton: false, showCloseButton: true, width: '450px'
                        });
                    }
                } else { throw new Error(result.msg || "ä¸Šå‚³å¤±æ•—"); }
            } catch (err) {
                console.error(err);
                Swal.fire({ icon: 'error', title: 'ä¸Šå‚³å¤±æ•—', text: "ä¼ºæœå™¨å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", confirmButtonColor: '#d33' });
            } finally {
                btn.disabled = false;
                btnText.innerHTML = "ç¢ºèªç°½ç½²ä¸¦é€å‡ºåˆç´„";
            }
        }

        function alertAndFocus(msg, id) {
            Swal.fire({ icon: 'warning', title: 'è«‹æª¢æŸ¥æ¬„ä½', text: msg, confirmButtonColor: '#c5a47e' }).then(() => {
                const el = document.getElementById(id);
                if(el) { el.scrollIntoView({behavior: "smooth", block: "center"}); el.classList.add('highlight-error'); setTimeout(() => el.classList.remove('highlight-error'), 1500); }
            });
        }
    </script>
</body>
</html>
